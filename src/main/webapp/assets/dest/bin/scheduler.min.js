/*! scheduler 16-11-2015 */
var fanliApp=angular.module("fanliApp",["ngRoute","ngResource","common.service","job_manage.service","job_monitor.service","component.service","ui.bootstrap","constant.service","fanli.filter","table.service"]);fanliApp.config(function(a){a.when("/",{templateUrl:"monitor.html",controller:"MonitorCtrl"}).when("/mytask",{templateUrl:"mytask.html",controller:"myTaskCtrl"}).when("/taskAdd",{templateUrl:"CalculateTaskConfig.html",controller:"taskAddCtrl"}).when("/transport",{templateUrl:"transport.html",controller:"transportTaskAddCtrl"}).when("/job_log/:instanceId",{templateUrl:"job_log.html",controller:"jobLogCtrl"}).when("/calculate_task_edit/:taskid",{templateUrl:"calculate_task_edit.html",controller:"taskEditCtrl"}).when("/transfer_task_edit/:taskid",{templateUrl:"transport_edit.html",controller:"transferEditCtrl"}).when("/feedback",{templateUrl:"feedback.html",controller:"feedbackCtrl"}).when("/compatible",{templateUrl:"other_task.html",controller:"OtherTaskCtrl"}).when("/instance_status_tree/:instanceId",{templateUrl:"instance_status.html",controller:"instanceStatusCtrl"})}),fanliApp.controller("taskAddCtrl",["$scope","$http","$modal","$filter","ConstantService","component","JobManageService","DimService","DolService",function(a,b,c,d,e,f,g,h,i){function j(){console.log("dol name:"+o());var b=i.parseDolToGetTable({dolName:o()});b.$promise.then(function(b){b.isSuccess?(a.table_name=b.result,l(),a.isLoading=!1,a.showImportMsg=!0,a.alertType="alert-success",a.importMsg="dol导入成功",q(!1,!1,!0),a.showConfig=!0):(a.isLoading=!1,a.showImportMsg=!0,a.alertType="alert-danger",a.importMsg="dol导入成功，但表名解析失败")},function(b){a.isLoading=!1,a.showImportMsg=!0,a.alertType="alert-danger",a.importMsg="dol导入成功，但表名解析失败"})}function k(){if(""==a.dolPath||void 0==a.dolPath)return a.showImportMsg=!0,a.alertType="alert-danger",a.importMsg="dol路径不能为空",!1;if(""==a.developer||void 0==a.developer)return a.showImportMsg=!0,a.alertType="alert-danger",a.importMsg="开发者不能为空",!1;if(""==a.db||void 0==a.db)return a.showImportMsg=!0,a.alertType="alert-danger",a.importMsg="目标库不能为空",!1;var b=a.dolPath.split(".");return"dol"!=b[b.length-1]?(a.showImportMsg=!0,a.alertType="alert-danger",a.importMsg="请检查dol路径，文件必须以.dol结尾",!1):!0}function l(){a.conf_taskName="hive##"+a.db.name+"."+a.table_name,a.conf_developer=a.developer.chName,a.conf_frequency="0 5 0 * * ?",a.conf_taskGroup=a.taskGroupOptions[1].ID,a.conf_cycle="D",a.conf_priority=2,a.conf_ifRecall=1,a.conf_recallLimit=3,a.conf_recallInterval=9,a.conf_successCode="0",a.conf_waitCode="",a.conf_offset="D0",a.conf_timeout=90,a.conf_para1=""}function m(){var b=[];if(a.dependenceTasks.length>0)for(var c=0;c<a.dependenceTasks.length;c++)b.push({taskId:a.generatedTaskId,preId:a.dependenceTasks[c].taskId,offset:parseInt(a.dependenceTasks[c].offset.substring(1))});return console.log(b),b}function n(){var b,c=o();return b="H"==a.conf_cycle?"canaan -dol "+c+" -t ${unix_timestamp} ":"canaan -dol "+c+" -d ${date}"}function o(){var b=a.dolPath.split("/");return b[b.length-1]}a.showImportMsg=!1,a.isLoading=!1,a.dolPath="";var p=function(){var b=h.queryAllDevelopers({},{});b.$promise.then(function(b){b.isSuccess&&(a.developerOptions=b.results)},function(){})};p(),a.hiveDatabases=[{id:1,name:"dw",desc:""},{id:2,name:"ods",desc:""},{id:3,name:"load",desc:""},{id:4,name:"dm",desc:""},{id:5,name:"rpt",desc:""},{id:6,name:"dim",desc:""}],a.cycleOptions={mi:"分",H:"时",D:"日",W:"周",M:"月",Y:"年"},a.taskGroupOptions=e.getTaskGroupOption(),a.priorityOptions=[{ID:1,Text:"高"},{ID:2,Text:"中"},{ID:3,Text:"低"}],a.ifRecallOptions=[{ID:1,Text:"是"},{ID:0,Text:"否"}],a.recallLimitOptions=[1,2,3,4,5,6,7,8,9,10],a.recallIntervalOptions=[{ID:1,Text:"1分钟"},{ID:2,Text:"2分钟"},{ID:3,Text:"3分钟"},{ID:4,Text:"4分钟"},{ID:5,Text:"5分钟"},{ID:6,Text:"6分钟"},{ID:7,Text:"7分钟"},{ID:8,Text:"8分钟"},{ID:9,Text:"9分钟"},{ID:10,Text:"10分钟"}],a.offsetOptions=["D0","D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","M0","M1","M2","M3","M4","M5","M6","M7","M8","M9","M10"],a.timeoutOptions=[{ID:30,Text:"30分钟"},{ID:60,Text:"1小时"},{ID:90,Text:"1.5小时"},{ID:120,Text:"2小时"},{ID:150,Text:"2.5小时"},{ID:180,Text:"3小时"},{ID:210,Text:"3.5小时"},{ID:240,Text:"4小时"}],a.tableRefreshTypes=e.getTableRefreshCycle(),a.tableType="MANAGED_TABLE";var q=function(b,c,d){a.taskConfPre=b,a.taskConfSave=c,a.taskConfNext=d};a.postDolInfo=function(){a.showImportMsg=!1,k()&&(a.loadingMsg="loading...",a.isLoading=!0,b.get("/fanli/dol/importDol",{params:{dolPath:a.dolPath}}).success(function(b){b.isSuccess?j():(a.isLoading=!1,a.showImportMsg=!0,a.alertType="alert-danger",a.importMsg=b.messages)}).error(function(b){console.log("not success"),a.isLoading=!1,a.showImportMsg=!0,a.alertType="alert-danger",a.importMsg=b.messages}))},a.change=function(){console.log(a.developer.chName)},a.setDefaultFreq=function(){switch(a.conf_taskGroup){case 1:a.conf_frequency="0 30 0 * * ?";break;case 2:a.conf_frequency="0 5 0 * * ?";break;case 3:a.conf_frequency="0 0 3 * * ?";break;case 4:a.conf_frequency="0 0 1 * * ?";break;case 5:a.conf_frequency="0 0 4 * * ?";break;case 6:a.conf_frequency="0 5 0 * * ?"}},a.dependenceTasks=[],a.cycleChanged=function(){"W"==a.cycle&&(a.conf_frequency="0 5 0 * * MON")};var r=function(){return""===a.successCode?(a.showCfgMsg=!0,a.cfgMsg="成功返回码不能为空",!1):!0},s=function(){a.message={headerText:"确认？",bodyText:"请确认此任务的前驱是如下任务,这将严重影响调度的稳定性：<br>"+x(),actionButtonStyle:"btn-danger",showCancel:!0};var b=c.open({templateUrl:"dialog/pretaskAlert.html",controller:MessageCtrl,resolve:{msg:function(){return a.message}}});return b};a.submitTaskConfig=function(){a.showCfgMsg=!1,a.cfgMsg="";var c=!1,d=s();d.result.then(function(d){c=!0;var e=r();if(console.log(c),e&&c){a.cfgSaveLoadingMsg="正在保存配置和依赖信息......",a.cfgSaveIsLoading=!0;var f=g.addTask({},{taskGroupId:a.conf_taskGroup,taskName:a.conf_taskName,tableName:a.table_name,resource:"hive",command:n(),cycle:a.conf_cycle,priority:a.conf_priority,ifRecall:a.conf_ifRecall,ifWait:0,ifPre:t(),ifEnable:1,freq:a.conf_frequency,owner:a.conf_developer,waitCode:a.conf_waitCode,recallCode:"",successCode:a.conf_successCode,timeout:a.conf_timeout,recallInterval:a.conf_recallInterval,logFile:"/data1/log/applog",addUser:a.conf_developer,updateUser:a.conf_developer,type:2,offset:a.conf_offset,recallLimit:a.conf_recallLimit,concurrency:1});f.$promise.then(function(c){c.isSuccess&&(a.generatedTaskId=c.result.taskId,a.dependenceTasks.length>0?b.post("/fanli/taskManager/taskpreadd",JSON.stringify(m())).success(function(b){a.saveSuccessMsg="保存成功",a.showSaveSucess=!0,q(!0,!0,!1),a.cfgSaveLoadingMsg="",a.cfgSaveIsLoading=!1,console.log("add pre success")}):(a.saveSuccessMsg="保存成功",a.showSaveSucess=!0,q(!0,!0,!1),a.cfgSaveLoadingMsg="",a.cfgSaveIsLoading=!1))})}},function(){c=!1})},a.getOffsetOptions=function(a){return e.getOffsetsByCycle(a)},a.getCycleText=function(a){return e.cycleToText(a)},a.getExecutionCycleLabel=function(a){return e.getCycleCss(a)};var t=function(){return a.dependenceTasks.length>0?1:0};a.returnStep1=function(){a.showConfig=!1,a.showImportMsg=!1,a.importMsg=""},a.gotoStep3=function(){q(!0,!0,!0),y(),u(!1,!1,!0),a.showMetaConfig=!0},a.returnStep2=function(){a.showMetaConfig=!1},a.saveMeta=function(){console.log(a.tableComment),u(!0,!0,!0),a.publishSuccess=!0,a.publishLoadingMsg="正在保存HIVE META信息......",b.post("/fanli/mdm/saveMeta",{tableName:a.table_name,description:a.tableComment,createTableInfo:v(a.metatable),columnDescription:w(a.showColumnTable),bloodRelation:x(),tableType:a.refreshType}).success(function(b){a.publishSuccess=!1,a.publishLoadingMsg="",u(!0,!0,!1),console.log("save success")}).error(function(b){u(!1,!1,!0),a.publishSuccess=!1,a.publishLoadingMsg=""})};var u=function(b,c,d){a.preThree=b,a.saveThree=c,a.publishThree=d};a.changeComment=function(a){};var v=function(b){for(var c="use "+a.db.name+";\ndrop table if exists "+b.table+";\ncreate external table "+b.table+"(\n",d=b.columns,e=b.partitions,f=0;f<d.length-1;f++)c=c+d[f].name+" "+d[f].type+",\n";if(c=c+d[d.length-1].name+" "+d[d.length-1].type+")\n",e.length>0){c+="PARTITIONED BY(";for(var f=0;f<e.length-1;f++)c=c+e[f].name+" "+e[f].type+",";c=c+e[e.length-1].name+" "+e[e.length-1].type+")\n"}return c+="STORED AS ORC;"},w=function(a){for(var b=[],c=a.displayedDataList,d=0;d<c.length;d++){var e=c[d];b.push({column:e.name,info:e.comment})}return b=JSON.stringify(b)},x=function(){var b="",c=a.dependenceTasks;if(c.length>0){b=c[0].taskName;for(var d=1;d<c.length;d++)b=b+","+c[d].taskName}return b};a.publish=function(){a.message={headerText:"提示",bodyText:"请确认是否执行如下建表语句，如有疑问请联系开发人员: <pre>"+v(a.metatable)+"</pre>",actionButtonStyle:"btn-danger",showCancel:!0};var d=c.open({templateUrl:"dialog/publish.html",controller:MessageCtrl,resolve:{msg:function(){return a.message}}});d.result.then(function(c){var d=v(a.metatable);a.publishSuccess=!0,a.publishLoadingMsg="正在建表...",b.post("/fanli/table/build",{sql:d}).success(function(b){a.publishStatusClass="alert-success",a.publishSuccess=!1,a.publishLoadingMsg="",a.showPublishResultMsg=!0,a.publishResultMsg="建表已成功",u(!0,!0,!0),console.log("建表成功")}).error(function(b){a.publishStatusClass="alert-danger",a.showPublishResultMsg=!0,a.publishResultMsg="建表失败，请联系调度开发人员",a.publishSuccess=!1,a.publishLoadingMsg=""})},function(){})};var y=function(){a.metaIsLoading=!0,a.metaLoadingMsg="正在加载元数据信息......",b.get("/fanli/domain/meta",{params:{db:"test",table:a.table_name}}).success(function(b){a.tableLocation=b.source,a.metatable=b,a.showColumnTable=f.getMultiHiveTableColumnTable(d,b.columns),a.partitions=b.partitions,a.metaIsLoading=!1,a.metaLoadingMsg=""})};a.showDependenceDialog=function(){a.message={headerText:"请选择依赖任务",data:a.dependenceTasks};var b=c.open({templateUrl:"dialog/taskDependencyDialog.html",controller:"TaskDependencyCtrl",windowClass:"taskQueryDialog",resolve:{msg:function(){return a.message}}});b.result.then(function(b){a.dependenceTasks=b},function(){})},a.deleteDependenceTask=function(b){a.message={headerText:"提示",bodyText:"是否删除任务前驱: "+a.dependenceTasks[b].taskId+" ?",actionButtonStyle:"btn-danger",showCancel:!0};var d=c.open({templateUrl:"dialog/message.html",controller:MessageCtrl,resolve:{msg:function(){return a.message}}});d.result.then(function(c){a.dependenceTasks.splice(b,1)},function(){})}}]),fanliApp.controller("TaskDependencyCtrl",function(a,b,c,d,e,f,g){function h(b,c){a.alert.msg=c,a.alert.type=b,a.alert.isShow=!0}function i(b){var c=l(b.taskId);-1!=c?(a.dependenceTasks.splice(c,1),h("success","成功删除依赖(taskId: "+b.taskId+", taskName: "+b.taskName+")")):h("warning","查找任务失败")}function j(b){var c={taskId:b.taskId,taskName:b.taskName,cycle:b.cycle,owner:b.owner,offset:b.cycle+"0"};a.dependenceTasks.push(c),h("success","成功添加依赖(taskId: "+b.taskId+", taskName: "+b.taskName+")")}function k(c){c.$promise.then(function(c){c.isSuccess&&(a.allTaskList=c.results,a.table=e.getCustomizedTable(a,b),a.hideTable=!1)})}a.dependenceTasks=d.data,a.taskGroups=g.getTaskGroupOption(),a.alert={type:"",msg:"",isShow:!1},a.queryPre=function(){var a=this.taskid,b=this.taskOwner,c=this.taskGroup,d=f.queryTasks({},{group:c,owner:b,id:a,isValid:1});k(d)},a.ok=function(){c.close(a.dependenceTasks)},a.setDependence=function(b){var c=b+(a.table.startIndex-1),d=a.table.displayedDataList[c];if(console.log(d.isSelected),d.isSelected){for(var e=!1,f=0;f<a.dependenceTasks.length;f++)d.taskId==a.dependenceTasks[f].taskId&&(e=!0);e?(h("warning","该依赖任务已存在，不能重复配置"),a.table.displayedDataList[c].isSelected=!1):j(d)}else i(d)};var l=function(b){for(var c=0;c<a.dependenceTasks.length;c++)if(a.dependenceTasks[c].taskId==b)return c;return-1}});var InfluencedTaskCtrl=function(a,b,c,d,e,f,g){function h(){i(),j()}function i(){a.msg=e,a.isLoading=!1,a.alert={type:"",msg:"",isShow:!1}}function j(){a.ok=function(){d.close("ok")},a.cancel=function(){d.dismiss("cancel")},a.getCycleText=function(a){return g.cycleToText(a)},a.getExecutionCycleLabel=function(a){return g.getCycleCss(a)},a.closeAlert=function(){a.alert.isShow=!1}}function k(){var b=f.getInfluencedTasksByTaskId({taskId:a.msg.taskId});a.isLoading=!0,a.closeAlert(),l(b)}function l(d){d.$promise.then(function(d){a.isLoading=!1,d.isSuccess?(a.allTaskList=d.results,a.table=c.getCustomizedTable(a,b),a.table.predicate="owner",a.table.reverse=!a.table.reverse):m("warning",d.messages)})}function m(b,c){a.alert.msg=c,a.alert.type=b,a.alert.isShow=!0}h(),k()},SameSourceTaskCtrl=function(a,b,c,d,e,f,g){function h(){i(),j()}function i(){a.msg=e,a.isLoading=!1,a.alert={type:"",msg:"",isShow:!1}}function j(){a.ok=function(){d.close("ok")},a.cancel=function(){d.dismiss("cancel")},a.getCycleText=function(a){return g.cycleToText(a)},a.getExecutionCycleLabel=function(a){return g.getCycleCss(a)},a.closeAlert=function(){a.alert.isShow=!1}}function k(){var b=f.getSameSourceTasksByTaskId({taskId:a.msg.taskId});a.isLoading=!0,a.closeAlert(),l(b)}function l(d){d.$promise.then(function(d){a.isLoading=!1,d.success?(a.allTaskList=d.results,a.table=c.getCustomizedTable(a,b),a.table.predicate="owner",a.table.reverse=!a.table.reverse):m("warning",d.messages)})}function m(b,c){a.alert.msg=c,a.alert.type=b,a.alert.isShow=!0}h(),k()},DirectInfluencedInstancesDialog=function(a,b,c,d,e,f,g){function h(){i(),j()}function i(){a.msg=e,a.isLoading=!1,a.alert={type:"",msg:"",isShow:!1},a.tableShow=!1}function j(){a.ok=function(){d.close("ok")},a.cancel=function(){d.dismiss("cancel")},a.getCycleText=function(a){return g.cycleToText(a)},a.getExecutionCycleLabel=function(a){return g.getCycleCss(a)},a.closeAlert=function(){a.alert.isShow=!1}}function k(){var b=f.getDirectInfluencedInstancesByInstanceId({instanceId:a.msg.instanceId});a.isLoading=!0,a.closeAlert(),l(b)}function l(d){d.$promise.then(function(d){a.isLoading=!1,d.isSuccess?(a.allTaskList=d.results,a.table=c.getCustomizedTable(a,b),a.table.predicate="owner",a.table.reverse=!a.table.reverse,a.tableShow=!0):m("warning",d.messages)})}function m(b,c){a.alert.msg=c,a.alert.type=b,a.alert.isShow=!0}h(),k()},PreRunTaskCtrl=function(a,b,c,d){function e(){f(),g()}function f(){a.msg=d,a.alert={type:"",msg:"",isShow:!1},a.isLoading=!1,a.returnBackTime={startDate:"",endDate:""}}function g(){a.cancel=function(){c.dismiss("cancel")},a.closeAlert=function(){a.alert.isShow=!1},a.ok=function(){var d,e,f;switch(a.datePickerStyle){case"H":d=a.time.startDate.split("-"),e=a.time.startTime.split(":"),f=new Date(d[0],d[1]-1,d[2],e[0],e[1],e[2]),f.setMilliseconds(f.getMilliseconds()-3),a.returnBackTime.startDate=b("dateFormat")(f,"yyyy-MM-dd hh:mm:ss",1),d=a.time.endDate.split("-"),e=a.time.endTime.split(":"),f=new Date(d[0],d[1]-1,d[2],e[0],e[1],e[2]),f.setHours(f.getHours()+1),a.returnBackTime.endDate=b("dateFormat")(f,"yyyy-MM-dd hh:mm:ss",1);break;case"D":case"W":d=a.time.startDate.split("-"),f=new Date(d[0],d[1]-1,d[2],0,0,0),a.returnBackTime.startDate=b("dateFormat")(f,"yyyy-MM-dd hh:mm:ss",1),d=a.time.endDate.split("-"),f=new Date(d[0],d[1]-1,d[2],0,0,0),f.setDate(f.getDate()+1),a.returnBackTime.endDate=b("dateFormat")(f,"yyyy-MM-dd hh:mm:ss",1);break;case"M":a.returnBackTime.startDate=a.time.startYear+"-"+a.time.startMonth+"-01",f=new Date(a.time.endYear,a.time.endMonth-1,"01"),f.setMonth(f.getMonth()+1),a.returnBackTime.endDate=b("dateFormat")(f,"yyyy-MM-dd",1)}var g=new Date(Date.parse(a.returnBackTime.startDate.replace(/\-/g,"/"))),h=new Date(Date.parse(a.returnBackTime.endDate.replace(/\-/g,"/")));g>h?(a.alert.isShow=!0,a.alert.type="danger",a.alert.msg="开始时间 大于 结束时间,请修改..."):c.close(a.returnBackTime)}}function h(){a.datePickerStyle=a.msg.jobExecCycle,a.time={startDate:"",startTime:"",endDate:"",endTime:"",startYear:"",startMonth:"",endYear:"",endMonth:"",months:["01","02","03","04","05","06","07","08","09","10","11","12"]},i()}function i(){var c=new Date((new Date).getTime());switch(a.datePickerStyle){case"H":a.time.startDate=b("dateFormat")(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),"yyyy-MM-dd",0),a.time.endDate=b("dateFormat")(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),"yyyy-MM-dd",0),a.time.startTime=c.getHours()>=1&&c.getHours()<=9?"0"+c.getHours()+":00:00":c.getHours()+":00:00",a.time.endTime=c.getHours()>=1&&c.getHours()<=9?"0"+c.getHours()+":00:00":c.getHours()+":00:00";break;case"D":case"W":a.time.startDate=b("dateFormat")(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),"yyyy-MM-dd",0),a.time.endDate=b("dateFormat")(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),"yyyy-MM-dd",0);break;case"M":a.time.startYear=c.getFullYear(),a.time.startMonth=c.getMonth()+1>=1&&c.getMonth()+1<=9?"0"+(c.getMonth()+1):c.getMonth()+1,a.time.endYear=c.getFullYear(),a.time.endMonth=c.getMonth()+1>=1&&c.getMonth()+1<=9?"0"+(c.getMonth()+1):c.getMonth()+1}}e(),h()},CascadeRecallTasksCtrl=function(a,b,c,d,e){function f(){g(),h()}function g(){a.msg=e,a.alert={type:"",msg:"",isShow:!1},a.isLoading=!0,a.filterTags=[]}function h(){a.ok=function(){if(new Date(a.cascadeRecallData.startDate)>new Date(a.cascadeRecallData.endDate))p("warning","开始时间大于结束时间,请修改");else{if(o(a.treeData),0==a.cascadeRecallData.instanceIds.length)return void p("warning","重跑实例列表为空");c.close(a.cascadeRecallData)}},a.cancel=function(){c.dismiss("cancel")},a.closeAlert=function(){a.alert.isShow=!1}}function i(){a.cascadeRecallData={startDate:"",endDate:"",instanceIds:[]};var c=new Date(a.msg.time_id);a.cascadeRecallData.startDate=b("dateFormat")(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),"yyyy-MM-dd",0),a.cascadeRecallData.endDate=b("dateFormat")(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),"yyyy-MM-dd",0),a.treeData={}}function j(){var b=d.recallCascadeGetInstances({instanceId:a.msg.jobInstanceId,date:a.msg.time_id});a.isLoading=!0,a.closeAlert(),k(b)}function k(b){b.$promise.then(function(b){p(b.success?"success":"warning",b.messages),a.isLoading=!1,b.success&&(a.cascadeJobs=b.results,angular.forEach(a.cascadeJobs,function(a){a.filtered=!1,a.deleted=!1}),a.treeData=l(a.cascadeJobs))})}function l(a){for(var b={},c=0;c<a.length;c++)b[a[c].preInstanceId]=[];for(var c=0;c<a.length;c++)n(b,a[c])||b[a[c].preInstanceId].push(a[c]);var d=[];for(d.push(a[0]);0!=d.length;){var e=d.splice(0,1)[0],f=e.instanceId,g=b[f];if(g)for(var c=0;c<g.length;c++){e.children||(e.children=[]);var h=m(g[c]);e.children.push(h),d.push(h)}}return a[0]}function m(a){var b={};return b.filtered=a.filtered,b.taskName=a.taskName,b.preInstanceId=a.preInstanceId,b.instanceId=a.instanceId,b.taskId=a.taskId,b}function n(a,b){for(var c=a[b.preInstanceId],d=0;d<c.length;d++){var e=c[d];if(e.instanceId==b.instanceId)return!0}return!1}function o(b){if(b.filtered||b.deleted||-1==a.cascadeRecallData.instanceIds.indexOf(b.instanceId)&&a.cascadeRecallData.instanceIds.push(b.instanceId),void 0==b.children&&void 0!=b._children)for(var c=0;c<b._children.length;c++)o(b._children[c]);if(void 0!=b.children&&void 0==b._children)for(var c=0;c<b.children.length;c++)o(b.children[c])}function p(b,c){a.alert.msg=c,a.alert.type=b,a.alert.isShow=!0}f(),i(),j()},CascadePreRunTasksCtrl=function(a,b,c,d,e){function f(){g(),h()}function g(){a.msg=e,a.alert={type:"",msg:"",isShow:!1},a.isLoading=!0,a.deleteNumber=0,a.filterTags=[]}function h(){a.ok=function(){if(new Date(a.cascadePreRunData.startDate)>new Date(a.cascadePreRunData.endDate))p("warning","开始时间大于结束时间,请修改");else{if(o(a.treeData),0==a.cascadePreRunData.taskIds.length)return void p("warning","预跑任务列表为空");var d=a.cascadePreRunData.endDate.split("-"),e=new Date(d[0],d[1]-1,d[2]);e.setDate(e.getDate()+1),a.cascadePreRunData.endDate=b("dateFormat")(e,"yyyy-MM-dd",1),c.close(a.cascadePreRunData)}},a.cancel=function(){c.dismiss("cancel")},a.closeAlert=function(){a.alert.isShow=!1}}function i(){a.cascadePreRunData={startDate:"",endDate:"",taskIds:[],instanceIds:[]};var c=new Date((new Date).getTime());a.cascadePreRunData.startDate=b("dateFormat")(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),"yyyy-MM-dd",0),a.cascadePreRunData.endDate=b("dateFormat")(c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),"yyyy-MM-dd",0),a.treeData={}}function j(){var b=d.getTasksForCascadePreRun({taskId:a.msg.taskId});a.isLoading=!0,a.closeAlert(),k(b)}function k(b){b.$promise.then(function(b){a.isLoading=!1,b.success&&(a.cascadeJobs=b.results,angular.forEach(a.cascadeJobs,function(a){a.filtered=!1,a.deleted=!1}),a.treeData=l(a.cascadeJobs))})}function l(a){for(var b={},c=0;c<a.length;c++)b[a[c].taskPreId]=[];for(var c=0;c<a.length;c++)n(b,a[c])||b[a[c].taskPreId].push(a[c]);var d=[];for(d.push(a[0]);0!=d.length;){var e=d.splice(0,1)[0],f=e.taskId,g=b[f];if(g)for(var c=0;c<g.length;c++){e.children||(e.children=[]);var h=m(g[c]);e.children.push(h),d.push(h)}}return a[0]}function m(a){var b={};return b.cycleGap=a.cycleGap,b.filtered=a.filtered,b.owner=a.owner,b.remark=a.remark,b.taskName=a.taskName,b.taskPreId=a.taskPreId,b.taskId=a.taskId,b.timeStamp=a.timeStamp,b}function n(a,b){for(var c=a[b.taskPreId],d=0;d<c.length;d++){var e=c[d];if(e.taskId==b.taskId)return!0}return!1}function o(b){if(b.filtered||b.deleted||-1==a.cascadePreRunData.taskIds.indexOf(b.taskId)&&a.cascadePreRunData.taskIds.push(b.taskId),void 0==b.children&&void 0!=b._children)for(var c=0;c<b._children.length;c++)o(b._children[c]);if(void 0!=b.children&&void 0==b._children)for(var c=0;c<b.children.length;c++)o(b.children[c])}function p(b,c){a.alert.msg=c,a.alert.type=b,a.alert.isShow=!0}f(),i(),j()},MessageCtrl=function(a,b,c){function d(){e(),f()}function e(){a.msg=c}function f(){a.ok=function(){b.close("ok")},a.cancel=function(){b.dismiss("cancel")}}d()},InstanceStateAnalyzeCtrl=function(a,b,c,d){function e(){f(),g()}function f(){a.msg=c}function g(){a.ok=function(){b.close("ok")},a.cancel=function(){b.dismiss("cancel")}}function h(){var b=d.instanceStatusAnalyze({instanceId:a.msg.instanceId});i(b)}function i(b){b.$promise.then(function(b){a.isLoading=!1,b.success&&(a.msg.bodyText=b.result)})}e(),h()};fanliApp.controller("feedbackCtrl",function(a,b){function c(){a.feedback_title="",a.feedback_content="",a.comments=[],d()}function d(){e.get({},function(b){b.isSuccess&&(console.log(b.results),a.comments=b.results)})}var e=b("/fanli/feedbacks");c(),a.saveFeedback=function(){""!=a.feedback_title&&""!=a.feedback_content&&e.save({comment:a.feedback_content,title:a.feedback_title,user:"somebody"},function(a){location.reload(),console.log(a.id)})}}),fanliApp.controller("instanceStatusCtrl",function(a,b,c){function d(a){var b={};a.self&&(b.name=a.self.taskName,b.itemStyle={normal:{color:e(a.self.status)}});var c=[];if(null!=a.parent){console.log(a.parent.length);for(var f=0;f<a.parent.length;f++){console.log(a.parent[f]);var g=d(a.parent[f]);c.push(g)}b.children=c}return b}function e(a){switch(a){case 0:return"#E3E3E3";case 1:return"#458B00";case 2:return"#63B8FF";case 3:return"#878787";case 4:return"#EEEE00";case 5:return"#EEAD0E";case 6:return"#FFFCC7";case 7:return"#0000FF";case-1:return"#FF3030";default:return"#ffffff"}}a.status_id=c.instanceId;var f=b("/fanli/monitor/instanceTree/:instanceId",{instanceId:"@instanceId"}),g=echarts.init(document.getElementById("instanceTree"));f.get({instanceId:a.status_id},function(a){if(200==a.code){var b=h(a.tree);console.log(JSON.stringify(b)),console.log("----"),g.setOption(b),console.log(g.getOption())}});var h=function(a){var b={},c={text:"树图"};c.subtext=a.self.instanceId+":"+a.self.taskName+"的血缘树",b.title=c;var e=[{name:"树图",type:"tree",orient:"vertical",rootLocation:{x:"center",y:"center"},nodePadding:150,roam:!0,direction:"inverse",symbol:"rectangle",symbolSize:30,itemStyle:{normal:{label:{show:!0,formatter:"{b}"},lineStyle:{color:"#48b",shadowColor:"#000",shadowBlur:3,shadowOffsetX:3,shadowOffsetY:5,type:"dotted"}},emphasis:{label:{show:!0}}}}],f=d(a);return e[0].data=[],e[0].data.push(f),b.series=e,b}}),fanliApp.controller("MonitorCtrl",function($scope,$http,$filter,$modal,$resource,component,ConstantService,JobMonitorService){function getJobByIndex(a){var b=getSelectedIndex(a);return $scope.table.displayedDataList[b]}function getSelectedIndex(a){return a+($scope.table.startIndex-1)}var dateToStr=function(x,y){var z={M:x.getMonth()+1,d:x.getDate(),h:x.getHours(),m:x.getMinutes(),s:x.getSeconds()};return y=y.replace(/(M+|d+|h+|m+|s+)/g,function(v){return((v.length>1?"0":"")+eval("z."+v.slice(-1))).slice(-2)}),y.replace(/(y+)/g,function(a){return x.getFullYear().toString().slice(-a.length)})},initDate=function(){return dateToStr(new Date,"yyyy-MM-dd")};$scope.startDate=initDate(),$scope.endDate=initDate(),$scope.hideTable=!0,$scope.executionStatusOptions=ConstantService.getJobMonitorStatus(),$scope.jobStatus=$scope.executionStatusOptions[1].ID,$scope.ifPreRun=!1,$scope.submitSearch=function(){setAlert(!1,"",""),setLoding(!0),$http.get("/fanli/monitor/query",{params:{taskId:$scope.taskId,owner:$scope.developer,startTime:$scope.startDate,endTime:$scope.endDate,status:$scope.jobStatus,isPre:$scope.ifPreRun?1:0}}).success(function(a){$scope.allTaskList=a.results,$scope.table=component.getCustomizedTable($scope,$filter),$scope.hideTable=!1,console.log($scope.table),setLoding(!1)}).error(function(){setAlert(!0,"alert-danger","未知异常"),setLoding(!1)})},$scope.getTimeid=function(a,b){return a.indexOf("pre")>=0?"D"==b?a.substring(10,14)+"-"+a.substring(14,16)+"-"+a.substring(16,18):"H"==b?a.substring(10,14)+"-"+a.substring(14,16)+"-"+a.substring(16,18)+"  "+a.substring(18,20):a:"D"==b?a.substring(6,10)+"-"+a.substring(10,12)+"-"+a.substring(12,14):"H"==b?a.substring(6,10)+"-"+a.substring(10,12)+"-"+a.substring(12,14)+"  "+a.substring(14,16):a},$scope.handleJobType=function(){$scope.submitSearch()},$scope.getExecutionCycleLabel=function(a){return ConstantService.getCycleCss(a)},$scope.getStatusText=function(a){return ConstantService.statusToText(a)},$scope.getCycleText=function(a){return ConstantService.cycleToText(a)},$scope.enterPress=function(a){13===a.which&&$scope.submitSearch()},$scope.instanceInfo=function(a){var b=getJobByIndex(a);window.open("#/job_log/"+b.taskStatusId)},$scope.reverse=!0,$scope.$watch("reverse",function(){$scope.jobInstanses=$filter("orderBy")($scope.jobInstanses,"startTime",$scope.reverse)}),$scope.getSortingClass=function(){return $scope.reverse?"sorting_asc":"sorting_desc"},$scope.showRelaTree=function(a){var b=getJobByIndex(a);window.open("#/instance_status_tree/"+b.taskStatusId)},$scope.reRunJob=function(a){console.log(a);var b=getJobByIndex(a);$scope.message={headerText:"提示",bodyText:"你是否要重跑任务实例: "+b.taskStatusId+" ?",actionButtonStyle:"btn-danger",showCancel:!0};var c=$modal.open({templateUrl:"/assets/pages/dialog/messageEnsure.html",controller:MessageCtrl,resolve:{msg:function(){return $scope.message}}});c.result.then(function(c){var d=JobMonitorService.recallInstance({instanceId:b.taskStatusId});$scope.isLoading=!0,d.$promise.then(function(c){$scope.isLoading=!1,$scope.table.displayedDataList[getSelectedIndex(a)].status=0,setAlert(!0,"alert-success","成功添加重跑任务"+b.taskStatusId+":"+b.taskName)},function(){})},function(){console.log("Modal dismissed at: "+new Date)})},$scope.successJob=function(a){var b=getJobByIndex(a);$scope.message={headerText:"警告: 以下任务实例将会直接受到影响，请确认是否将任务实例"+b.taskStatusId+"置为成功？",actionButtonStyle:"btn-primary",instanceId:b.taskStatusId};var c=$modal.open({templateUrl:"/assets/pages/dialog/directInfluencedInstancesDialog.html",controller:DirectInfluencedInstancesDialog,windowClass:"taskQueryDialog",resolve:{msg:function(){return $scope.message}}});c.result.then(function(c){var d=JobMonitorService.successInstance({instanceId:b.taskStatusId});$scope.isLoading=!0,setAlert(!1,"",""),d.$promise.then(function(b){setAlert(!0,"alert-success",b.messages),$scope.isLoading=!1,b.isSuccess&&($scope.table.displayedDataList[getSelectedIndex(a)].status=1)})},function(){})};var setAlert=function(a,b,c){$scope.alertShow=a,$scope.alertType=b,$scope.AlertMsg=c},setLoding=function(a){$scope.isLoading=a},itemStyle={normal:{}},option={title:{text:"树图",subtext:""},toolbox:{show:!0,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!1,series:[{name:"树图",type:"tree",orient:"vertical",rootLocation:{x:"center",y:350},nodePadding:3,roam:"scale",direction:"inverse",symbol:"rectangle",itemStyle:{normal:{label:{show:!1,formatter:"{b}"},lineStyle:{color:"#48b",shadowColor:"#000",shadowBlur:3,shadowOffsetX:3,shadowOffsetY:5,type:"curve"}},emphasis:{label:{show:!0}}},data:[{name:"根节点",value:6,itemStyle:{normal:{color:"#7b6800"}},children:[{name:"节点1",value:4,children:[{name:"叶子节点1",value:4},{name:"叶子节点2",value:4},{name:"叶子节点3",value:2},{name:"叶子节点4",value:2},{name:"叶子节点5",value:2},{name:"叶子节点6",value:4}]},{name:"节点2",value:4,children:[{name:"叶子节点7",value:4},{name:"叶子节点8",value:4}]},{name:"节点3",value:1,children:[{name:"叶子节点9",value:4},{name:"叶子节点10",value:4},{name:"叶子节点11",value:2},{name:"叶子节点12",value:2}]}]}]}]}}),fanliApp.controller("jobLogCtrl",function(a,b,c){a.status_id=b.instanceId;var d=function(b){c.get("/fanli/log/"+b).success(function(b){a.log_content=b.log})};d(a.status_id)}),fanliApp.controller("myTaskCtrl",["$scope","$filter","$modal","JobManageService","component","ConstantService",function(a,b,c,d,e,f){function g(){a.alert={type:"",msg:"",isShow:!1},a.isValid=!0,a.hideTable=!0,a.isLoading=!1}function h(c){c.$promise.then(function(c){c.isSuccess?(a.allTaskList=c.results,a.table=e.getCustomizedTable(a,b),a.isLoading=!1,a.hideTable=!1):console.log("没有成功")})}function i(b){a.isLoading=!0,a.loadingMsg=b}function j(b,c){a.isLoading=b,a.loadingMsg=c}function k(b){b.$promise.then(function(b){if(b.isSuccess){if(b.result<10){for(var c=b.results,d="",e=0;e<c.length;e++)d=d+c[e]+",";d=d.substring(0,d.length-1),a.showAlert("alert-success","成功预跑"+b.result+"个任务,taskid为："+d)}else a.showAlert("alert-success","成功预跑"+b.result+"个任务");j(!1,"")}else a.showAlert("alert-danger","生成实例失败，如有必要请联系开发人员！"),j(!1,"")},function(){a.showAlert("alert-danger","生成实例失败，如有必要请联系开发人员！"),j(!1,"")})}function l(b){var c=m(b);return a.table.displayedDataList[c]}function m(b){return b+(a.table.startIndex-1)}a.taskGroupOptions=f.getTaskGroupOption(),g(),a.closeAlert=function(){a.alert.isShow=!1},a.showAlert=function(b,c){a.alert.isShow=!0,a.alert.type=b,a.alert.msg=c},a.submitQuery=function(){i("正在查询中..."),a.closeAlert();var b=d.queryTasks({},{group:a.jobGroup,owner:a.jobDeveloper,id:a.jobID,isValid:1==a.isValid?1:0});h(b)},a.handleValid=function(){console.log(a.isValid),a.submitQuery()},a.editJob=function(a){var b=l(a);2==b.type?window.open("#/calculate_task_edit/"+b.taskId):window.open("#/transfer_task_edit/"+b.taskId)},a.preRunJob=function(b){var e=l(b);a.msg={headerText:"设置预跑任务:"+e.taskId+" 时间",actionButtonStyle:"btn-primary",jobExecCycle:e.cycle};var f=c.open({templateUrl:"/assets/pages/dialog/preRunDialog.html",controller:PreRunTaskCtrl,resolve:{msg:function(){return a.msg}}});f.result.then(function(b){var c=d.preRunTask({startTime:b.startDate,endTime:b.endDate,taskId:e.taskId});a.isLoading=!0,a.closeAlert(),k(c)},function(){})},a.validateJob=function(b){var c=l(b);a.isLoading=!0;var e=d.validateTask({taskId:c.taskId});a.closeAlert(),e.$promise.then(function(b){b.isSuccess?(a.isLoading=!1,a.showAlert("alert-success","成功上线任务"+c.taskName),a.submitQuery()):(a.isLoading=!1,a.showAlert("alert-danger","上线失败！"))},function(b){a.isLoading=!1,a.showAlert("alert-danger","上线失败！")})},a.invalidJob=function(b){var e=l(b);a.message={headerText:"警告: 以下任务将会受到影响，请确认是否失效任务"+e.taskId+"?",actionButtonStyle:"btn-danger",taskId:e.taskId};var f=c.open({templateUrl:"/assets/pages/dialog/influencedTasksDialog.html",controller:InfluencedTaskCtrl,windowClass:"taskQueryDialog",resolve:{msg:function(){return a.message}}});f.result.then(function(b){var c=d.invalidTask({taskId:e.taskId});a.isLoading=!0,a.closeAlert(),c.$promise.then(function(b){b.isSuccess?(a.isLoading=!1,a.showAlert("alert-success","成功将任务"+e.taskName+"从调度下线"),a.submitQuery()):(a.isLoading=!1,a.showAlert("alert-danger","下线失败！"))},function(b){a.isLoading=!1,a.showAlert("alert-danger","下线失败！")})},function(){console.log("Modal dismissed at: "+new Date)})},a.deleteJob=function(b){
var e=l(b);a.message={headerText:"警告: 以下任务将会受到影响，请确认是否删除任务"+e.taskId+"?",actionButtonStyle:"btn-danger",taskId:e.taskId};var f=c.open({templateUrl:"/assets/pages/dialog/influencedTasksDialog.html",controller:InfluencedTaskCtrl,windowClass:"taskQueryDialog",resolve:{msg:function(){return a.message}}});f.result.then(function(b){var c=d.deleteTask({taskId:e.taskId});a.isLoading=!0,a.closeAlert(),c.$promise.then(function(b){b.isSuccess?(a.isLoading=!1,a.showAlert("alert-success","成功将任务"+e.taskName+"从调度删除，如要恢复，请找开发同学"),a.submitQuery()):(a.isLoading=!1,a.showAlert("alert-danger","删除失败！"))},function(b){a.isLoading=!1,a.showAlert("alert-danger","删除失败！")})},function(){console.log("Modal dismissed at: "+new Date)})},a.getCycleText=function(a){return f.cycleToText(a)},a.getExecutionCycleLabel=function(a){return f.getCycleCss(a)},a.getGroupIdText=function(a){return f.taskGroupIdToText(a)},a.getTaskGroupCss=function(a){return f.getTaskGroupCss(a)},a.enterPress=function(b){13===b.which&&a.submitQuery()}}]),fanliApp.controller("OtherTaskCtrl",function(a,b,c,d,e,f){function g(){return"calculate"==a.conf_task_type?"shell":"transfer"==a.conf_task_type?"shell_transport":void 0}function h(){var b=[];if(a.dependenceTasks.length>0)for(var c=0;c<a.dependenceTasks.length;c++)b.push({taskId:a.generatedTaskId,preId:a.dependenceTasks[c].taskId,offset:parseInt(a.dependenceTasks[c].offset.substring(1))});return console.log(b),b}function i(b){a.generatedTaskId=b,a.dependenceTasks.length>0?c.post("/fanli/taskManager/taskpreadd",JSON.stringify(h())).success(function(b){b.isSuccess?(k(!1,""),j(!0,"alert-success","新增任务成功"),a.taskConfSave=!0):(k(!1,""),j(!0,"alert-danger","保存调度任务，但保存依赖信息失败")),l()}).error(function(){j(!0,"alert-danger","保存调度任务，但保存依赖信息失败"),k(!1,"")}):(a.taskConfSave=!0,k(!1,""),j(!0,"alert-success","新增任务成功"))}function j(b,c,d){a.sucShow=b,a.alerttype=c,a.sucMsg=d}function k(b,c){a.Loading=b,a.LoadingMsg=c}a.taskGroupOptions=e.getTaskGroupOption(),a.cycleOptions=e.getCycleOptions(),a.priorityOptions=e.getPriorityOption(),a.ifRecallOptions=e.getIfRecallOption(),a.recallLimitOptions=e.getRecallLimitOption(),a.recallIntervalOptions=e.getRecallIntervalOption(),a.offsetOptions=e.getOffsetOption(),a.timeoutOptions=e.getTimeOutOption(),a.timePatternOptions=e.getTimePatterns(),d.queryAllDevelopers().$promise.then(function(b){a.developerOptions=b.results}),a.conf_frequency="0 5 0 * * ?",a.conf_taskGroup=a.taskGroupOptions[1].ID,a.conf_cycle="D",a.conf_priority=2,a.conf_ifRecall=1,a.conf_recallLimit=3,a.conf_recallInterval=9,a.conf_successCode="0",a.conf_waitCode="",a.conf_offset="D0",a.conf_timeout=90,a.conf_para1="",a.dependenceTasks=[],a.conf_db_name="",a.conf_table_name="",a.conf_src="",a.conf_target="",a.setCommandTime=function(){a.conf_para1=a.conf_para1+" "+a.time_pattern},a.$watch("[conf_table_name,conf_db_name]",function(){"calculate"==a.conf_task_type?a.conf_taskName="hive##"+a.conf_db_name+"."+a.conf_table_name:"transfer"==a.conf_task_type&&(a.conf_taskName=a.conf_src+"2"+a.conf_target+"##"+a.conf_table_name)}),a.$watch("[conf_src,conf_target]",function(){a.conf_taskName=a.conf_src+"2"+a.conf_target+"##"+a.conf_table_name}),a.showDependenceDialog=function(){a.message={headerText:"请选择依赖任务",data:a.dependenceTasks};var c=b.open({templateUrl:"dialog/taskDependencyDialog.html",controller:"TaskDependencyCtrl",windowClass:"taskQueryDialog",resolve:{msg:function(){return a.message}}});c.result.then(function(b){a.dependenceTasks=b},function(){})},a.deleteDependenceTask=function(c){a.message={headerText:"提示",bodyText:"是否删除任务前驱: "+a.dependenceTasks[c].taskId+" ?",actionButtonStyle:"btn-danger",showCancel:!0};var d=b.open({templateUrl:"dialog/message.html",controller:MessageCtrl,resolve:{msg:function(){return a.message}}});d.result.then(function(b){a.dependenceTasks.splice(c,1)},function(){})},a.submitTaskConfig=function(){j(!1,"",""),k(!0,"保存中...");var b=f.addTask({},{taskGroupId:a.conf_taskGroup,taskName:a.conf_taskName,tableName:a.conf_table_name,resource:g(),command:a.conf_para1,cycle:a.conf_cycle,priority:a.conf_priority,ifRecall:a.conf_ifRecall,ifWait:0,ifPre:m(),ifEnable:1,freq:a.conf_frequency,owner:a.conf_developer.chName,waitCode:a.conf_waitCode,recallCode:"",successCode:a.conf_successCode,timeout:a.conf_timeout,recallInterval:a.conf_recallInterval,logFile:"/data1/log/applog",addUser:a.conf_developer.chName,updateUser:a.conf_developer.chName,type:"transfer"==a.conf_task_type?1:2,offset:a.conf_offset,recallLimit:a.conf_recallLimit,concurrency:1});b.$promise.then(function(a){if(a.isSuccess){var b=a.result.taskId;console.log(b),i(b)}else j(!0,"alert-danger","保存调度任务失败")})},a.getOffsetOptions=function(a){return e.getOffsetsByCycle(a)},a.getCycleText=function(a){return e.cycleToText(a)},a.getExecutionCycleLabel=function(a){return e.getCycleCss(a)};var l=function(){var a=document.body.scrollTop||document.documentElement.scrollTop,b=setInterval(function(){a-=100,100>a&&(a=0,window.scrollTo(a,a),clearInterval(b)),window.scrollTo(a,a)},"250")},m=function(){return a.dependenceTasks.length>0?1:0}}),fanliApp.controller("sidebarCtrl",function(a,b){a.isActive=function(a){return a===b.path()}}),fanliApp.controller("taskEditCtrl",function(a,b,c,d,e,f){function g(){return a.dependenceTasks.length>0?1:0}function h(){var b=[];if(a.dependenceTasks.length>0)for(var c=0;c<a.dependenceTasks.length;c++)b.push({taskId:d.taskid,preId:a.dependenceTasks[c].taskId,offset:parseInt(a.dependenceTasks[c].offset.substring(1))});return console.log(b),b}a.taskid=d.taskid,a.Loading=!0,a.LoadingMsg="加载中...",a.taskGroupOptions=f.getTaskGroupOption(),a.cycleOptions={mi:"分",H:"时",D:"日",W:"周",M:"月",Y:"年"},a.priorityOptions=[{ID:1,Text:"高"},{ID:2,Text:"中"},{ID:3,Text:"低"}],a.ifRecallOptions=[{ID:1,Text:"是"},{ID:0,Text:"否"}],a.recallLimitOptions=[1,2,3,4,5,6,7,8,9,10],a.recallIntervalOptions=[{ID:1,Text:"1分钟"},{ID:2,Text:"2分钟"},{ID:3,Text:"3分钟"},{ID:4,Text:"4分钟"},{ID:5,Text:"5分钟"},{ID:6,Text:"6分钟"},{ID:7,Text:"7分钟"},{ID:8,Text:"8分钟"},{ID:9,Text:"9分钟"},{ID:10,Text:"10分钟"}],a.offsetOptions=["D0","D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","M0","M1","M2","M3","M4","M5","M6","M7","M8","M9","M10"],a.timeoutOptions=[{ID:30,Text:"30分钟"},{ID:60,Text:"1小时"},{ID:90,Text:"1.5小时"},{ID:120,Text:"2小时"},{ID:150,Text:"2.5小时"},{ID:180,Text:"3小时"},{ID:210,Text:"3.5小时"},{ID:240,Text:"4小时"}];var i=function(b){var c=e.queryTaskById({taskid:b});c.$promise.then(function(b){b.isSuccess&&(j(b.result),a.Loading=!1)},function(){})},j=function(b){a.conf_taskName=b.taskName,a.conf_developer=b.owner,a.conf_frequency=b.freq,a.conf_taskGroup=b.taskGroupId,a.conf_cycle=b.cycle,a.conf_priority=b.priority,a.conf_ifRecall=b.ifRecall,a.conf_recallLimit=b.recallLimit,a.conf_recallInterval=b.recallInterval,a.conf_successCode=b.successCode,a.conf_waitCode=b.waitCode,a.conf_offset=b.offset,a.conf_timeout=b.timeout,a.conf_para1=b.command},k=function(b){var c=e.queryPreTaskById({taskid:b});c.$promise.then(function(b){i(d.taskid),a.dependenceTasks=b.results},function(){})};k(d.taskid),a.updateTaskCfg=function(){a.showSaveSucess=!1,a.saveSuccessMsg="";var b=e.updateTask({},{taskId:d.taskid,taskName:a.conf_taskName,owner:a.conf_developer,freq:a.conf_frequency,taskGroupId:a.conf_taskGroup,cycle:a.conf_cycle,priority:a.conf_priority,ifRecall:a.conf_ifRecall,recallLimit:a.conf_recallLimit,recallInterval:a.conf_recallInterval,successCode:a.conf_successCode,waitCode:a.conf_waitCode,offset:a.conf_offset,timeout:a.conf_timeout,command:a.conf_para1,ifPre:g()});b.$promise.then(function(a){a.isSuccess&&l()},function(){})};var l=function(){var a=e.updatePre({},{taskId:d.taskid,cfgs:h()});a.$promise.then(function(a){a.isSuccess&&m("保存成功")},function(){})},m=function(b){a.showSaveSucess=!0,a.saveSuccessMsg=b};a.getOffsetOptions=function(a){return f.getOffsetsByCycle(a)},a.getCycleText=function(a){return f.cycleToText(a)},a.getExecutionCycleLabel=function(a){return f.getCycleCss(a)},a.deleteDependenceTask=function(b){a.message={headerText:"提示",bodyText:"是否删除任务前驱: "+a.dependenceTasks[b].taskId+" ?",actionButtonStyle:"btn-danger",showCancel:!0};var d=c.open({templateUrl:"dialog/message.html",controller:MessageCtrl,resolve:{msg:function(){return a.message}}});d.result.then(function(c){a.dependenceTasks.splice(b,1)},function(){})},a.showDependenceDialog=function(){a.message={headerText:"请选择依赖任务",data:a.dependenceTasks};var b=c.open({templateUrl:"dialog/taskDependencyDialog.html",controller:"TaskDependencyCtrl",windowClass:"taskQueryDialog",resolve:{msg:function(){return a.message}}});b.result.then(function(b){a.dependenceTasks=b},function(){})}}),fanliApp.controller("transferEditCtrl",function(a,b,c,d,e,f,g,h){function i(){window.document.title=b.taskid,a.taskGroupOptions=g.getTaskGroupOption(),a.cycleOptions=g.getCycleOptions(),a.priorityOptions=g.getPriorityOption(),a.ifRecallOptions=g.getIfRecallOption(),a.recallLimitOptions=g.getRecallLimitOption(),a.recallIntervalOptions=g.getRecallIntervalOption(),a.offsetOptions=g.getOffsetOption(),a.timeoutOptions=g.getTimeOutOption(),a.sql_disable=!0}function j(){var c=[];if(a.dependenceTasks.length>0)for(var d=0;d<a.dependenceTasks.length;d++)c.push({taskId:b.taskid,preId:a.dependenceTasks[d].taskId,offset:parseInt(a.dependenceTasks[d].offset.substring(1))});return console.log(c),c}function k(){return a.dependenceTasks.length>0?1:0}function l(b){q(!0,"正在获取传输配置......"),f.getTransferTaskById({taskid:b}).$promise.then(function(a){o(a),n(b),m(b),q(!1,"")},function(){a.errorShow=!0,a.cfgMsg="获取传输配置信息失败，请联系开发"})}function m(b){d.get("/fanli/load/pre",{params:{taskId:b}}).success(function(b){if(b.isSuccess){a.writerParamMap=JSON.parse(b.result);var c=a.writerParamMap.pre;a.preSql=c,q(!1,"")}}).error(function(a){q(!1,"")})}function n(b){var c=d.get("/fanli/load/sql",{params:{taskid:b}});c.success(function(b){if(b.isSuccess){a.paramMap=JSON.parse(b.result);var c=a.paramMap.sql;a.sql=c,q(!1,"")}}).error(function(a){q(!1,"")})}function o(b){var c=b.taskName,d=c.split("##"),e=d[0].split(2);a.conf_src=e[0],a.conf_target=e[1],a.conf_targetTable=d[1],a.conf_taskName=b.taskName,a.conf_developer=b.owner,a.conf_frequency=b.freq,a.conf_taskGroup=b.taskGroupId,a.conf_cycle=b.cycle,a.conf_priority=b.priority,a.conf_ifRecall=b.ifRecall,a.conf_recallLimit=b.recallLimit,a.conf_recallInterval=b.recallInterval,a.conf_successCode=b.successCode,a.conf_waitCode=b.waitCode,a.conf_offset=b.offset,a.conf_timeout=b.timeout,a.conf_para1=b.command}function p(b){a.showSaveSucess=!0,a.saveSuccessMsg=b}function q(b,c){a.Loading=b,a.LoadingMsg=c}i(),a.submitTaskCfg=function(){q(!0,"正在修改传输任务......"),a.showSaveSucess=!1;var c=f.updateTransferTask({},{taskId:b.taskid,taskGroupId:a.conf_taskGroup,taskName:a.conf_taskName,command:a.conf_para1,cycle:a.conf_cycle,priority:a.conf_priority,ifRecall:a.conf_ifRecall,freq:a.conf_frequency,owner:a.conf_developer.chName,waitCode:a.conf_waitCode,successCode:a.conf_successCode,timeout:a.conf_timeout,recallInterval:a.conf_recallInterval,updateUser:a.conf_developer.chName,offset:a.conf_offset,recallLimit:a.conf_recallLimit,ifPre:k()});c.$promise.then(function(a){a.isSuccess&&r()},function(){})};var r=function(){var a=f.updatePre({},{taskId:b.taskid,cfgs:j()});a.$promise.then(function(a){a.isSuccess&&s()},function(){})};a.setTaskName=function(){a.conf_taskName=a.conf_src+"2"+a.conf_target+"##"+a.conf_targetTable};var s=function(){if(!a.sql)return q(!1,""),void p("修改成功");a.paramMap.sql=a.sql;var c=e("/fanli/load/sql",{taskid:"@taskid",paramMap:"@paramMap"});c.save({},{taskid:b.taskid,paramMap:a.paramMap},function(a){a.isSuccess&&(q(!1,""),p("修改成功"),console.log("修改sql成功"))}),console.log(a.paramMap)};a.submitWriterParam=function(){if(!a.preSql)return void(a.preEdit=!a.preEdit);a.writerParamMap.pre=a.preSql;var c=e("/fanli/load/pre",{taskid:"@taskid",paramMap:"@paramMap"});c.save({},{taskid:b.taskid,paramMap:a.writerParamMap},function(b){b.isSuccess&&(a.preEdit=!a.preEdit,console.log("pre sql update successfully!"))},function(a){alert("pre sql update failed!")})},l(b.taskid);var t=function(b){var c=f.queryPreTaskById({taskid:b});c.$promise.then(function(b){a.dependenceTasks=b.results},function(){a.errorShow=!0,a.cfgMsg="获取前置信息失败，请联系开发"})};t(b.taskid),a.deleteDependenceTask=function(b){a.message={headerText:"提示",bodyText:"是否删除任务前驱: "+a.dependenceTasks[b].taskId+" ?",actionButtonStyle:"btn-danger",showCancel:!0};var d=c.open({templateUrl:"dialog/message.html",controller:MessageCtrl,resolve:{msg:function(){return a.message}}});d.result.then(function(c){a.dependenceTasks.splice(b,1)},function(){})},a.showDependenceDialog=function(){a.message={headerText:"请选择依赖任务",data:a.dependenceTasks};var b=c.open({templateUrl:"dialog/taskDependencyDialog.html",controller:"TaskDependencyCtrl",windowClass:"taskQueryDialog",resolve:{msg:function(){return a.message}}});b.result.then(function(b){a.dependenceTasks=b},function(){})},a.getOffsetOptions=function(a){return g.getOffsetsByCycle(a)},a.getCycleText=function(a){return g.cycleToText(a)},a.getExecutionCycleLabel=function(a){return g.getCycleCss(a)}}),fanliApp.controller("transportTaskAddCtrl",function(a,b,c,d,e,f,g,h){function i(){var b=e.queryAllDevelopers({},{});b.$promise.then(function(b){b.isSuccess&&(a.developerOptions=b.results)},function(){})}function j(){a.conf_taskName=a.conf_src+"2"+a.conf_target+"##"+a.conf_target_db+"."+a.conf_targetTable}function k(){return"append"==a.conf_target_table_type||"append_only"==a.conf_target_table_type?"incr":"full"==a.conf_target_table_type?"full":"snapshot"==a.conf_target_table_type?"snapshot":void 0}function l(){b.get("/fanli/db/columns",{params:{tableName:a.conf_src_table.trim(),connectProp:a.conf_src_domain,db:a.conf_src_db}}).success(function(b){b.isSuccess&&(a.fieldOptions=b.result.columns)})}function m(){b.get("/fanli/domain/meta",{params:{db:a.conf_src_db,table:a.conf_src_table.trim()}}).success(function(b){a.fieldOptions=b.partitions})}function n(){"hive"==a.conf_src?b.get("/fanli/domain/meta",{params:{db:a.conf_src_db,table:a.conf_src_table.trim()}}).success(function(b){var c=b.partitions,d=b.columns;a.commonColumn=d,a.partitionColumn=c,r(),a.SRCColumn=v(c,d),p()}):b.get("/fanli/db/columns",{params:{tableName:a.conf_src_table.trim(),connectProp:a.conf_src_domain,db:a.conf_src_db}}).success(function(b){if(b.isSuccess){a.commonColumn=b.result.columns,r();var c=b.result.columns;a.SRCColumn=o(c),p()}})}function o(a){var b=a.length,c={name:"ins_date",type:"timestamp",comment:"入库时间",index:b},d={name:"upd_date",type:"timestamp",comment:"更新时间",index:b+1};return a.push(c),a.push(d),a}function p(){var b=d.queryCreateTableSql({},{name:a.conf_targetTable,columns:a.SRCColumn,partitions:w(),dbType:a.conf_target,schema:q()});b.$promise.then(function(b){a.conf_create_table_sql=b.result,console.log(a.conf_create_table_sql)},function(){})}function q(){return a.conf_src_db}function r(){var b=a.commonColumn,c="select ";if("sqlserver"==a.conf_src){c=c+"["+b[0].name+"]";for(var d=1;d<b.length;d++)c=c+",["+b[d].name+"]";c+=",getdate(),getdate()"}else if("mysql"==a.conf_src){c=c+"`"+b[0].name+"`";for(var d=1;d<b.length;d++)c=c+",`"+b[d].name+"`";c+=",now(),now()"}else{c=c+"`"+b[0].name+"`";for(var d=1;d<b.length;d++)c=c+",`"+b[d].name+"`";c=s(c)}if(c="hive"!=a.conf_src?c+" from "+a.conf_src_table:c+" from "+a.conf_src_db+"."+a.conf_src_table,"append"==a.conf_target_table_type||"append_only"==a.conf_target_table_type){var e=u(a.conf_incr_field);console.log("增量字段是:"+e);var f=t(a.conf_src,e.type);c+=f}a.conf_transfer_sql=c,console.log("查询sql是："+c)}function s(b){for(var c=a.partitionColumn,d=0;d<c.length;d++)b=b+",`"+c[d].name+"`";return b}function t(b,c){var d;if("hive"==b)switch(a.conf_cycle){case"H":d="ds='${yyyy-MM-dd;P1H}' and hour='${HH;P1H}'";break;case"D":d=a.conf_incr_field+"='${yyyy-MM-dd;P1D}'";break;case"M":d=a.conf_incr_field+">='${yyyy-MM-01;P1M}' and "+a.conf_incr_field+"<'${yyyy-MM-01}'";break;case"W":d=a.conf_incr_field+">='${yyyy-MM-dd;F1W}' and "+a.conf_incr_field+"<'${yyyy-MM-dd;F0W}'";break;case"Y":d=a.conf_incr_field+">='${yyyy-01-01};P1Y' and "+a.conf_incr_field+"<'${yyyy-01-01}'"}else if("mysql"==b)if("int"==c.toLowerCase())switch(a.conf_cycle){case"H":d="FROM_UNIXTIME("+a.conf_incr_field+", '%Y-%m-%d-%H')='${yyyy-MM-dd-HH;P1H}'";break;case"D":d="FROM_UNIXTIME("+a.conf_incr_field+", '%Y-%m-%d')='${yyyy-MM-dd;P1D}'";break;case"M":d="FROM_UNIXTIME("+a.conf_incr_field+", '%Y-%m')='${yyyy-MM;P1M}'";break;case"W":d="FROM_UNIXTIME("+a.conf_incr_field+", '%Y-%m-%d')>='${yyyy-MM-dd;F1W}' and FROM_UNIXTIME("+a.conf_incr_field+", '%Y-%m-%d')<'${yyyy-MM-dd;F0W}'";break;case"Y":d="FROM_UNIXTIME("+a.conf_incr_field+", '%Y')='${yyyy;P1Y}'"}else{if("datetime"!=c.toLowerCase()&&"timestamp"!=c.toLowerCase())return" where "+a.conf_incr_field;switch(a.conf_cycle){case"H":d=a.conf_incr_field+">='${yyyy-MM-dd HH:00:00;P1H}' and "+a.conf_incr_field+"<'${yyyy-MM-dd HH:00:00}'";break;case"D":d=a.conf_incr_field+">='${yyyy-MM-dd 00:00:00;P1D}' and "+a.conf_incr_field+"<'${yyyy-MM-dd 00:00:00}'";break;case"M":d=a.conf_incr_field+">='${yyyy-MM-01 00:00:00;P1M}' and "+a.conf_incr_field+"<'${yyyy-MM-01 00:00:00}'";break;case"W":d=a.conf_incr_field+">='${yyyy-MM-dd 00:00:00;F1W}' and "+a.conf_incr_field+"<'${yyyy-MM-dd 00:00:00;F0W}'";break;case"Y":d=a.conf_incr_field+">='${yyyy-01-01 00:00:00;P1Y}' and "+a.conf_incr_field+"<'${yyyy-01-01 00:00:00}'"}}else if("sqlserver"==b){if("datetime"!=c.toLowerCase()&&"smalldatetime"!=c.toLowerCase())return" where "+a.conf_incr_field;switch(a.conf_cycle){case"H":d=a.conf_incr_field+">='${yyyy-MM-dd HH:00:00;P1H}' and "+a.conf_incr_field+"<'${yyyy-MM-dd HH:00:00}'";break;case"D":d=a.conf_incr_field+">='${yyyy-MM-dd 00:00:00;P1D}' and "+a.conf_incr_field+"<'${yyyy-MM-dd 00:00:00}'";break;case"M":d=a.conf_incr_field+">='${yyyy-MM-01 00:00:00;P1M}' and "+a.conf_incr_field+"<'${yyyy-MM-01 00:00:00}'";break;case"W":d=a.conf_incr_field+">='${yyyy-MM-dd 00:00:00;F1W}' and "+a.conf_incr_field+"<'${yyyy-MM-dd 00:00:00;F0W}'";break;case"Y":d=a.conf_incr_field+">='${yyyy-01-01 00:00:00;P1Y}' and "+a.conf_incr_field+"<'${yyyy-01-01 00:00:00}'"}}return" where "+d}function u(b){for(var c=0;c<a.fieldOptions.length;c++)if(a.fieldOptions[c].name==b)return a.fieldOptions[c]}function v(a,b){for(var c=b,d=0;d<a.length;d++)c.push(a[d]);return c}function w(){var b=[];if("append"==a.conf_target_table_type||"snapshot"==a.conf_target_table_type||"append_only"==a.conf_target_table_type)switch(a.conf_cycle){case"H":"h"==a.conf_partition_desc?(b.push({name:"ds",type:"string",comment:""}),b.push({name:"hour",type:"string",comment:""})):"d"==a.conf_partition_desc?b.push({name:"ds",type:"string",comment:""}):"n"==a.conf_partition_desc;break;case"D":"d"==a.conf_partition_desc?b.push({name:"ds",type:"string",comment:""}):"n"==a.conf_partition_desc;break;case"M":"m"==a.conf_partition_desc?b.push({name:"month",type:"string",comment:""}):"n"==a.conf_partition_desc;break;case"Y":"y"==a.conf_partition_desc?b.push({name:"year",type:"string",comment:""}):"n"==a.conf_partition_desc;break;case"W":"w"==a.conf_partition_desc?b.push({name:"week",type:"string",comment:""}):"n"==a.conf_partition_desc}return b}function x(){""!=a.conf_src&&""!=a.conf_src_table&&void 0!=a.conf_src_table&&("mysql"==a.conf_src||"sqlserver"==a.conf_src?z():"hive"==a.conf_src&&y())}function y(){b.get("/fanli/domain/meta",{params:{db:a.conf_src_db,table:a.conf_src_table.trim()}}).success(function(b){a.src_tables=[];var c=b.table;a.src_tables.push(c)})}function z(){b.get("/fanli/db/tableInfo",{params:{tableName:a.conf_src_table.trim(),connectProp:a.conf_src_domain,db:a.conf_src_db}}).success(function(b){b.isSuccess&&(a.src_tables=b.results)})}function A(){"hive"==a.conf_src?(a.targetOptions=[],a.targetOptions.push("sqlserver")):("mysql"==a.conf_src||"sqlserver"==a.conf_src)&&(a.targetOptions=[],a.targetOptions.push("hive")),console.log("now conf_target is :"+a.conf_target)}function B(){var b=[{name:"源介质",value:a.conf_src},{name:"源域名",value:a.conf_src_domain},{name:"源表名",value:a.conf_src_table}],c=!0;return angular.forEach(b,function(b){c&&(""==b.value||void 0==b.value)&&("源域名"==b.name?("mysql"==a.conf_src||"sqlserver"==a.conf_src)&&(C(!0,b.name+"不能为空"),c=!1):(C(!0,b.name+"不能为空"),c=!1))}),c}function C(b,c){a.formInvalid=b,a.formCheckMsg=c}function D(){a.step1=!0,a.conf_src="",a.conf_target="",a.conf_targetTable="",a.conf_hive_partition="",a.dependenceTasks=[],a.setTaskName=function(){a.conf_taskName=a.conf_src+"2"+a.conf_target+"##"+a.conf_targetTable},i(),a.taskGroupOptions=f.getTaskGroupOption(),a.cycleOptions=f.getCycleOptions(),a.priorityOptions=f.getPriorityOption(),a.ifRecallOptions=f.getIfRecallOption(),a.recallLimitOptions=f.getRecallLimitOption(),a.recallIntervalOptions=f.getRecallIntervalOption(),a.offsetOptions=f.getOffsetOption(),a.timeoutOptions=f.getTimeOutOption(),a.hivePartitionOptions=f.getTransferHivePartition(),a.storagePatternOptions=f.getStoragePattern(),a.partitionDescOptions=f.getPartitionDesc(),a.topicOptions=f.getTopic(),a.conf_frequency="0 5 0 * * ?",a.conf_taskGroup=a.taskGroupOptions[1].ID,a.conf_cycle="D",a.conf_priority=2,a.conf_ifRecall=1,a.conf_recallLimit=3,a.conf_recallInterval=9,a.conf_successCode="0",a.conf_waitCode="",a.conf_offset="D0",a.conf_timeout=90,a.conf_para1="",a.getOffsetOptions=function(a){return f.getOffsetsByCycle(a)},a.getCycleText=function(a){return f.cycleToText(a)},a.getExecutionCycleLabel=function(a){return f.getCycleCss(a)},a.submitTaskCfg=function(){I(),T(!0,"正在新增传输任务......");var b=g.addTransferTask({},{taskGroupId:a.conf_taskGroup,taskName:a.conf_taskName,tableName:a.conf_targetTable,resource:"hive"==a.conf_src?a.conf_target_domain:a.conf_src_domain,command:"",cycle:a.conf_cycle,priority:a.conf_priority,ifRecall:a.conf_ifRecall,ifWait:0,ifPre:U(),ifEnable:1,freq:a.conf_frequency,owner:a.conf_developer.chName,waitCode:a.conf_waitCode,recallCode:"",successCode:a.conf_successCode,timeout:a.conf_timeout,recallInterval:a.conf_recallInterval,logFile:"/data1/log/applog",addUser:a.conf_developer.chName,updateUser:a.conf_developer.chName,type:1,offset:a.conf_offset,recallLimit:a.conf_recallLimit,concurrency:1});b.$promise.then(function(a){if(a.isSuccess){var b=a.result.taskId;G(b),F(b)}},function(a){T(!1,"")})}}function E(){var b=[];if(a.dependenceTasks.length>0)for(var c=0;c<a.dependenceTasks.length;c++)b.push({taskId:a.generatedTaskId,preId:a.dependenceTasks[c].taskId,offset:parseInt(a.dependenceTasks[c].offset.substring(1))});return console.log(b),b}function F(c){a.generatedTaskId=c,a.dependenceTasks.length>0?b.post("/fanli/taskManager/taskpreadd",JSON.stringify(E())).success(function(a){a.isSuccess&&H(c)}).error(function(){S(!0,"alert-danger","保存依赖信息失败")}):H(c)}function G(b){var c=g.updateTransferTask({},{taskId:b,command:"sh /home/hadoop/wormhole/test/bin/wormhole.sh "+b+" ${unix_timestamp} "+a.conf_offset});console.log("sh /home/hadoop/wormhole/test/bin/wormhole.sh "+b+" ${unix_timestamp} "+a.conf_offset),c.$promise.then(function(a){a.isSuccess&&console.log("更新command成功")},function(){})}function H(b){T(!0,"正在保存传输参数......");var c=g.addEtlLoadCfg({},{taskId:b,parameterMap:JSON.stringify(a.reader),type:"reader",isValid:1});c.$promise.then(function(c){if(c.isSuccess){var d=g.addEtlLoadCfg({},{taskId:b,parameterMap:JSON.stringify(a.writer),type:"writer",isValid:1});d.$promise.then(function(b){b.isSuccess&&(R("新增传输成功"),a.suceessAndDisable=!0,T(!1,""))},function(){S(!0,"alert-danger","保存写参数失败！")})}},function(){S(!0,"alert-danger","保存读参数失败！")})}function I(){"hive"==a.conf_src&&"sqlserver"==a.conf_target?L():"mysql"==a.conf_src&&"hive"==a.conf_target?O():"sqlserver"==a.conf_src&&"hive"==a.conf_target&&J()}function J(){a.reader={plugin:"sqlserverreader",connectProps:a.conf_src_domain,dbname:a.conf_src_db,encoding:"UTF-8",sql:a.conf_transfer_sql,concurrency:"1",needSplit:"false"},a.writer={plugin:"hdfswriter",dir:Q(),prefix_filename:a.conf_targetTable,field_split:"	",line_split:"\n",encoding:"UTF-8",buffer_size:"4096",file_type:"TXT",concurrency:"1",hive_table_add_partition_switch:K(),hive_table_add_partition_condition:P()}}function K(){var a=w();return a.length>0?!0:!1}function L(){a.reader={plugin:"hivereader",sql:a.conf_transfer_sql,mode:"READ_FROM_LOCAL",dataDir:"hdfs://namenode171:54310/tmp",reduceNumber:"-1",concurrency:"1"},a.writer={plugin:"sqlserverwriter",connectProps:a.conf_target_domain,dbname:a.conf_target_db,encoding:"UTF-8",concurrency:"1",tableName:a.conf_src_db+"."+a.conf_targetTable,columns:N(),pre:M()}}function M(){if("full"==a.conf_target_table_type||"append_only"==a.conf_target_table_type)return"delete from "+a.conf_src_db+"."+a.conf_targetTable;if("append"==a.conf_target_table_type){var b,c="delete from "+a.conf_src_db+"."+a.conf_targetTable+" where ";switch(a.conf_cycle){case"H":b="ds='${yyyy-MM-dd;P1H}' and hour='${HH;P1H}'";break;case"D":b=a.conf_incr_field+"='${yyyy-MM-dd;P1D}'";break;case"M":b=a.conf_incr_field+">='${yyyy-MM-01;P1M}' and "+a.conf_incr_field+"<'${yyyy-MM-01}'";break;case"W":b=a.conf_incr_field+">='${yyyy-MM-dd;F1W}' and "+a.conf_incr_field+"<'${yyyy-MM-dd;F0W}'";break;case"Y":b=a.conf_incr_field+">='${yyyy-01-01;P1Y}' and "+a.conf_incr_field+"<'${yyyy-01-01}'"}return c+=b}}function N(){var b=a.SRCColumn,c="";c+=b[0].name;for(var d=1;d<b.length;d++)c=c+","+b[d].name;return console.log("hive 列："+c),c}function O(){a.reader={plugin:"mysqlreader",connectProps:a.conf_src_domain,dbname:a.conf_src_db,encoding:"UTF-8",sql:a.conf_transfer_sql,concurrency:"1",needSplit:"false"},a.writer={plugin:"hdfswriter",dir:Q(),prefix_filename:a.conf_targetTable,field_split:"	",line_split:"\n",encoding:"UTF-8",buffer_size:"4096",file_type:"TXT",concurrency:"1",hive_table_add_partition_switch:K(),hive_table_add_partition_condition:P()}}function P(){if(!K())return"";var b;switch(a.conf_cycle){case"H":if("h"==a.conf_partition_desc){b="ds='${yyyy-MM-dd}',hour='${HH;P1H}'@"+a.conf_targetTable+"."+a.conf_target_db;break}b="ds='${yyyy-MM-dd;P1D}'@"+a.conf_targetTable+"."+a.conf_target_db;break;case"D":b="ds='${yyyy-MM-dd;P1D}'@"+a.conf_targetTable+"."+a.conf_target_db;break;case"W":b="ds='${yyyy-MM-dd;F1W}'@"+a.conf_targetTable+"."+a.conf_target_db;break;case"M":b="ds='${yyyy-MM;P1M}'@"+a.conf_targetTable+"."+a.conf_target_db;break;case"Y":b="ds='${yyyy;P1Y}'@"+a.conf_targetTable+"."+a.conf_target_db}return b}function Q(){var b="";b="tmpdb"==a.conf_target_db?"hdfs://namenode171:54310/tmp/tmp.db/"+a.conf_targetTable:"hdfs://namenode171:54310/user/hive/bi_warehouse/"+a.conf_target_db.toUpperCase()+".db/"+a.conf_targetTable.toLowerCase();var c=w(),d=f.getPartitionByCycle();if(c.length>0)switch(a.conf_cycle){case"H":if("h"==a.conf_partition_desc){b+=d.H;break}if("d"==a.conf_partition_desc){b+=d.HD;break}case"D":b+=d.D;break;case"W":b+=d.W;break;case"M":b+=d.M;break;case"Y":b+=d.Y}return b}function R(b){a.showSaveSucess=!0,a.saveSuccessMsg=b}function S(b,c,d){a.sucShow=b,a.alerttype=c,a.sucMsg=d}function T(b,c){a.Loading=b,a.LoadingMsg=c}D(),a.$watch("[conf_cycle,conf_target_table_type]",function(){if("full"==a.conf_target_table_type)a.partitionDescOptions=[{id:0,name:"n",desc:"无分区"}];else{switch(a.conf_cycle){case"H":a.partitionDescOptions=[{id:1,name:"h",desc:"天(ds),小时(hour)"},{id:2,name:"d",desc:"天(ds)"}];break;case"D":a.partitionDescOptions=[{id:1,name:"d",desc:"天(ds)"}];break;case"W":a.partitionDescOptions=[{id:1,name:"w",desc:"周(week)"}];break;case"M":a.partitionDescOptions=[{id:1,name:"m",desc:"月(month)"}];break;case"Y":a.partitionDescOptions=[{id:1,name:"y",desc:"年(year)"}]}"append_only"==a.conf_target_table_type&&a.partitionDescOptions.push({id:0,name:"n",desc:"无分区"})}}),a.$watch("conf_target_table_type",function(){a.getTargetTableName()}),a.returnStep2=function(){a.step3=!1,a.step2=!0},a.showDependenceDialog=function(){a.dependenceTasks=[],a.message={headerText:"请选择依赖任务",data:a.dependenceTasks};var b=c.open({templateUrl:"dialog/taskDependencyDialog.html",controller:"TaskDependencyCtrl",windowClass:"taskQueryDialog",resolve:{msg:function(){return a.message}}});b.result.then(function(b){a.dependenceTasks=b},function(){})},a.deleteDependenceTask=function(b){a.message={headerText:"提示",bodyText:"是否删除任务前驱: "+a.dependenceTasks[b].taskId+" ?",actionButtonStyle:"btn-danger",showCancel:!0};var d=c.open({templateUrl:"dialog/message.html",controller:MessageCtrl,resolve:{msg:function(){return a.message}}});d.result.then(function(c){a.dependenceTasks.splice(b,1)},function(){})},a.targetSelect=function(){if(console.log("target select is "+a.conf_target),"hive"==a.conf_target)a.target_database_options=["load","ods","dim","tmpdb"];else{var b=e.querySourceDB({type:a.conf_target});b.$promise.then(function(b){b.isSuccess&&(a.target_domain_options=b.results)},function(){})}console.log(a.conf_target)},a.sourceSelect=function(){if(console.log("src select is :"+a.conf_src),a.src_database_options=[],"hive"==a.conf_src)a.src_database_options=["load","ods","dw","dm","dim","tmpdb"];else{var b=e.querySourceDB({type:a.conf_src});b.$promise.then(function(b){b.isSuccess&&(a.src_domain_options=b.results)},function(){})}},a.src_domain_select=function(){T(!0,"正在获取表..."),console.log(a.conf_src_domain),b.get("/fanli/db/tables",{params:{connectProp:a.conf_src_domain}}).success(function(b){b.isSuccess&&(a.src_database_options=b.results),T(!1,"")}).error(function(){T(!1,"")})},a.target_domain_select=function(){return"sqlserver_bi"==a.conf_target_domain?void(a.target_database_options=["dw","dw_temp"]):(T(!0,"正在获取表..."),console.log(a.conf_target_domain),void b.get("/fanli/db/tables",{params:{connectProp:a.conf_target_domain}}).success(function(b){b.isSuccess&&(a.target_database_options=b.results),T(!1,"")}).error(function(){T(!1,"")}))},a.ensureSql=function(){if(T(!0,"正在建表..."),j(),"sqlserver"==a.conf_target)console.log(a.conf_create_table_sql),b.post("/fanli/db/buildTables",{connectProp:a.conf_target_domain,db:a.conf_target_db,sql:a.conf_create_table_sql}).success(function(b){b.isSuccess?(T(!1,""),S(!0,"alert-success","建表成功"),a.buildBtn=!0,a.step4=!0):(T(!1,""),S(!0,"alert-danger","建表失败"))}).error(function(a){T(!1,""),S(!0,"alert-danger","建表失败")});else if("hive"==a.conf_target){var c="use "+a.conf_target_db+";\n"+a.conf_create_table_sql+"\n";console.log(c);var e=d.buildHiveTable({},{sql:c});e.$promise.then(function(b){b.isSuccess?(T(!1,""),a.buildBtn=!0,a.step4=!0):(T(!1,""),S(!0,"alert-danger","建表失败"))},function(){})}},a.incrFieldChange=function(){},a.submitForm=function(){C(!1,""),B()&&(a.getTargetTableName(),x())},a.getTargetTableName=function(){if("hive"==a.conf_src)return void(a.conf_targetTable=a.conf_src_table);var b=k(),c=void 0!=a.conf_partition_desc?a.conf_partition_desc:"",d=void 0!=a.conf_topic?a.conf_topic:"",e=void 0!=a.conf_table_name_desc?a.conf_table_name_desc:"";"hive"!=a.conf_target||"load"!=a.conf_target_db&&"ods"!=a.conf_target_db?"hive"!=a.conf_target||"dw"!=a.conf_target_db&&"dm"!=a.conf_target_db?"hive"==a.conf_target&&"dim"==a.conf_target_db?a.conf_targetTable="s_"+a.conf_src_table:"hive"==a.conf_target&&"tmpdb"==a.conf_target_db&&(a.conf_targetTable=a.conf_table_name_desc):a.conf_targetTable=b+"_"+c+"_"+d+"_"+e:a.conf_targetTable=b+"_"+c+"_"+a.conf_src_table,console.log(a.conf_targetTable)},a.getIncrField=function(){"full"!=a.conf_target_table_type&&"snapshot"!=a.conf_target_table_type&&("append"==a.conf_target_table_type||"append_only"==a.conf_target_table_type)&&(a.fieldOptions=[],"hive"==a.conf_src?m():l())},a.saveTargetInfo=function(){n(),a.step2=!1,a.step3=!0},a.setDefaultFreq=function(){if("H"==a.conf_cycle)return void(a.conf_frequency="0 5 * * * ?");switch(a.conf_taskGroup){case 1:a.conf_frequency="0 30 0 * * ?";break;case 2:a.conf_frequency="0 5 0 * * ?";break;case 3:a.conf_frequency="0 0 3 * * ?";break;case 4:a.conf_frequency="0 0 1 * * ?";break;case 5:a.conf_frequency="0 0 4 * * ?";break;case 6:a.conf_frequency="0 5 0 * * ?"}},a.add_transfer=function(b){A(),a.step1=!1,a.step2=!0};var U=function(){return a.dependenceTasks.length>0?1:0}}),angular.module("common.service",["ngResource"]).value("serverAddress","/fanli").factory("CommonService",["$resource","$routeParams","serverAddress",function(a,b,c){
return a(c+"/common/:action",{},{getCurrentMonitor:{method:"GET",params:{action:"getCurrentMonitor"}},updateMonitorByForce:{method:"POST",params:{action:"updateMonitorByForce"}},sendReply:{method:"POST",params:{action:"sendReply",reply:"@reply",email:"@email"}},isAdmin:{method:"GET",params:{action:"isAdmin",resourceId:"@resourceId"}},isOwnerByTaskId:{method:"GET",params:{action:"isTaskOwner",taskId:"@taskId"}},importGit:{method:"GET",params:{action:"importGit",projectName:"@projectName",fileName:"@fileName"}},getCurrentUser:{method:"GET",params:{action:"getCurrentUser"}},getLogoutUrl:{method:"GET",params:{action:"getLogoutUrl"}},getGitTree:{method:"GET",params:{action:"getGitTree"}},publishGitFile:{method:"POST",params:{action:"publishGitFile",projectName:"@projectName",fileName:"@fileName"}},getGitFile:{method:"POST",params:{action:"getGitFile",fileName:"@fileName"}}})}]).factory("UserService",["$rootScope","CommonService",function(a,b){function c(){b.getCurrentUser({}).$promise.then(function(a){a.success&&d(a.result)},function(a){})}function d(c){f.pinyinName=c.employPinyin,f.realName=c.employeeName,f.email=c.employeeEmail,f.userId=c.employeeId,f.loginId=c.loginId;for(var d=0;d<Global.AllTeam.length;d++)if(Global.AllTeam[d][0]==f.pinyinName){f.isDeveloper=!0;break}$("#userName").text(f.realName),b.isAdmin({resourceId:"1"}).$promise.then(function(b){f.isAdmin=b.success,a.$broadcast("userVerified")},function(a){})}function e(){b.getLogoutUrl({}).$promise.then(function(a){a.success&&$(".user-menu a").attr("href",a.result)},function(a){})}var f={isAdmin:!1,isDeveloper:!1,pinyinName:"",realName:"",isOwner:!1,email:"",userId:"",loginId:-1};return c(),e(),{getUser:function(){return f}}}]),angular.module("component.service",[]).value("component",{getCustomizedTable:function(a,b){function c(a,b){this.recordPerPageOptions=[5,10,25,50,100],this.selectedRecordPerPage=this.recordPerPageOptions[2],this.displayedDataList=a.allTaskList,this.total=this.displayedDataList.length,this.currentPage=1,this.startIndex=1,this.endIndex=Math.min(this.selectedRecordPerPage,this.total),this.pageNumber=Math.ceil(this.total/this.selectedRecordPerPage),this.maxPageNumDisplayed=5,this.query="",this.updateStartIndex=function(){this.startIndex=(this.currentPage-1)*this.selectedRecordPerPage+1},this.updateEndIndex=function(){this.endIndex=Math.min(this.startIndex+this.selectedRecordPerPage-1,this.total)},this.updatePageNumber=function(){this.pageNumber=Math.ceil(this.total/this.selectedRecordPerPage)},this.updateIndexes=function(){this.updateStartIndex(),this.updateEndIndex()},this.getCurrentPageNumDisplay=function(){var a=[];if(0==this.total)return a;for(var b=Math.max(this.currentPage-2,1);b<=Math.min(this.pageNumber,this.currentPage+2);b++)a.push(b);var c=Math.min(this.maxPageNumDisplayed,this.pageNumber);if(a.length<c)if(1===a[0])for(var b=1;b<=c-a.length+1;b++)a.push(a[a.length-1]+1);else for(var b=1;b<=c-a.length+1;b++)a.unshift(a[0]-1);return a},this.getActiveLabel=function(a){return this.currentPage===a?"active":void 0},this.changePage=function(a){this.currentPage=a},this.previousPage=function(){this.currentPage>1&&(this.currentPage=this.currentPage-1)},this.nextPage=function(){this.currentPage<this.pageNumber&&(this.currentPage=this.currentPage+1)},this.getDisableLabelforPrevious=function(){return 0===this.total||1===this.currentPage?"disabled":void 0},this.getDisableLabelforNext=function(){return 0===this.total||this.currentPage===this.pageNumber?"disabled":void 0},this.gotoFirstPage=function(){this.currentPage=1},this.gotoLastPage=function(){this.currentPage=this.pageNumber},this.getSortingClass=function(a){return this.predicate===a?this.reverse?"sorting_asc":"sorting_desc":"sorting"},a.$watch("table.currentPage",function(){a.table.updateIndexes()}),a.$watch("table.selectedRecordPerPage",function(){a.table.currentPage=1,a.table.updateIndexes(),a.table.updatePageNumber()}),a.$watch("table.total",function(){0==a.table.total?(a.table.startIndex=0,a.table.endIndex=0):(a.table.updateIndexes(),a.table.updatePageNumber())}),a.$watch("table.query",function(){a.table.displayedDataList=b("filter")(a.allTaskList,a.table.query),a.table.total=a.table.displayedDataList.length,a.table.currentPage=1}),a.$watchCollection("[table.predicate, table.reverse]",function(){a.table.displayedDataList=b("orderBy")(a.table.displayedDataList,a.table.predicate,a.table.reverse)}),a.$watchCollection("allTaskList",function(){a.table.displayedDataList=a.allTaskList,a.table.query&&(a.table.displayedDataList=b("filter")(a.table.displayedDataList,a.table.query)),a.table.reverse&&(a.table.displayedDataList=b("orderBy")(a.table.displayedDataList,a.table.predicate,a.table.reverse)),a.table.total=a.table.displayedDataList.length})}return new c(a,b)},getSpecTialTable:function(a,b,c){function d(a,b,c){this.recordPerPageOptions=[10,25,50,100],this.selectedRecordPerPage=this.recordPerPageOptions[0],this.displayedDataList=c,this.total=this.displayedDataList.length,this.currentPage=1,this.startIndex=1,this.endIndex=Math.min(this.selectedRecordPerPage,this.total),this.pageNumber=Math.ceil(this.total/this.selectedRecordPerPage),this.maxPageNumDisplayed=5,this.justShowSuccess=!1,this.statusConditions=[{ID:-3,Text:"--选择全部--"},{ID:1,Text:"success"},{ID:-2,Text:"unsuccess"},{ID:-1,Text:"fail"},{ID:0,Text:"init"},{ID:2,Text:"running"},{ID:3,Text:"suspend"},{ID:4,Text:"init_error"},{ID:5,Text:"wait"},{ID:6,Text:"ready"},{ID:7,Text:"timeout"}],this.showStatus=this.statusConditions[2].ID,this.query="",this.updateStartIndex=function(){this.startIndex=(this.currentPage-1)*this.selectedRecordPerPage+1},this.updateEndIndex=function(){this.endIndex=Math.min(this.startIndex+this.selectedRecordPerPage-1,this.total)},this.updatePageNumber=function(){this.pageNumber=Math.ceil(this.total/this.selectedRecordPerPage)},this.updateIndexes=function(){this.updateStartIndex(),this.updateEndIndex()},this.getCurrentPageNumDisplay=function(){var a=[];if(0==this.total)return a;for(var b=Math.max(this.currentPage-2,1);b<=Math.min(this.pageNumber,this.currentPage+2);b++)a.push(b);var c=Math.min(this.maxPageNumDisplayed,this.pageNumber);if(a.length<c)if(1===a[0])for(var b=1;b<=c-a.length+1;b++)a.push(a[a.length-1]+1);else for(var b=1;b<=c-a.length+1;b++)a.unshift(a[0]-1);return a},this.getActiveLabel=function(a){return this.currentPage===a?"active":""},this.changePage=function(a){this.currentPage=a},this.previousPage=function(){this.currentPage>1&&(this.currentPage=this.currentPage-1)},this.nextPage=function(){this.currentPage<this.pageNumber&&(this.currentPage=this.currentPage+1)},this.getDisableLabelforPrevious=function(){return 0===this.total||1===this.currentPage?"disabled":void 0},this.getDisableLabelforNext=function(){return 0===this.total||this.currentPage===this.pageNumber?"disabled":void 0},this.gotoFirstPage=function(){this.currentPage=1},this.gotoLastPage=function(){this.currentPage=this.pageNumber},this.getSortingClass=function(a){return this.predicate===a?this.reverse?"sorting_asc":"sorting_desc":"sorting"}}return new d(a,b,c)},getMultiHiveTableColumnTable:function(a,b){function c(a,b){this.recordPerPageOptions=[10,25,50,100],this.selectedRecordPerPage=this.recordPerPageOptions[0],this.displayedDataList=b,this.total=this.displayedDataList.length,this.currentPage=1,this.startIndex=1,this.endIndex=Math.min(this.selectedRecordPerPage,this.total),this.pageNumber=Math.ceil(this.total/this.selectedRecordPerPage),this.maxPageNumDisplayed=5,this.query="",this.updateStartIndex=function(){0==this.total?this.startIndex=0:this.startIndex=(this.currentPage-1)*this.selectedRecordPerPage+1},this.updateEndIndex=function(){0==this.total?this.endIndex=0:this.endIndex=Math.min(this.startIndex+this.selectedRecordPerPage-1,this.total)},this.updatePageNumber=function(){this.pageNumber=Math.ceil(this.total/this.selectedRecordPerPage)},this.updateIndexes=function(){this.updateStartIndex(),this.updateEndIndex()},this.getCurrentPageNumDisplay=function(){var a=[];if(0==this.total)return a;for(var b=Math.max(this.currentPage-2,1);b<=Math.min(this.pageNumber,this.currentPage+2);b++)a.push(b);var c=Math.min(this.maxPageNumDisplayed,this.pageNumber);if(a.length<c)if(1===a[0])for(var b=1;b<=c-a.length+1;b++)a.push(a[a.length-1]+1);else for(var b=1;b<=c-a.length+1;b++)a.unshift(a[0]-1);return a},this.getActiveLabel=function(a){return this.currentPage===a?"active":""},this.changePage=function(a){this.currentPage=a,this.updateIndexes()},this.previousPage=function(){this.currentPage>1&&(this.currentPage=this.currentPage-1,this.updateIndexes())},this.nextPage=function(){this.currentPage<this.pageNumber&&(this.currentPage=this.currentPage+1,this.updateIndexes())},this.getDisableLabelforPrevious=function(){return 0===this.total||1===this.currentPage?"disabled":void 0},this.getDisableLabelforNext=function(){return 0===this.total||this.currentPage===this.pageNumber?"disabled":void 0},this.gotoFirstPage=function(){this.currentPage=1,this.updateIndexes()},this.gotoLastPage=function(){this.currentPage=this.pageNumber,this.updateIndexes()},this.getSortingClass=function(a){return this.predicate===a?this.reverse?"sorting_asc":"sorting_desc":"sorting"},this.selectedRecordPerPageChanged=function(){this.currentPage=1,this.updateIndexes(),this.updatePageNumber()},this.queryChanged=function(){this.displayedDataList=a("filter")(b,this.query),this.total=this.displayedDataList.length,this.currentPage=1,this.updateIndexes(),this.updatePageNumber()}}return new c(a,b)}}),angular.module("constant.service",[]).factory("ConstantService",[function(){return{getTableRefreshCycle:function(){return[{ID:"any",Text:"--请选择--"},{ID:"full",Text:"全量"},{ID:"append",Text:"增量"}]},getJobMonitorStatus:function(){return[{ID:100,Text:"不限"},{ID:99,Text:"unsuccess"},{ID:1,Text:"success"},{ID:-1,Text:"fail"},{ID:0,Text:"init"},{ID:4,Text:"init-error"},{ID:3,Text:"suspend"},{ID:5,Text:"wait"},{ID:2,Text:"running"},{ID:6,Text:"ready"},{ID:7,Text:"timeout"}]},getCycleCss:function(a){switch(a){case"H":return"label-warning";case"D":return"label-primary";case"W":return"label-success";case"M":return"label-danger";case"Y":return"label-purple"}},getTaskGroupCss:function(a){switch(a){case 1:return"label label-warning arrowed arrowed-right";case 2:return"label arrowed";case 3:return"label label-success arrowed-in arrowed-in-right";case 4:return"label label-danger arrowed";case 5:return"label label-info arrowed-right arrowed-in";case 6:return"label label-yellow arrowed-in"}},taskGroupIdToText:function(a){switch(a){case 1:return"ODS";case 2:return"LOAD";case 3:return"DM";case 4:return"DW";case 5:return"EXPORT";case 6:return"DIM";case 7:return"ONLINE"}},getTimePatterns:function(){return[{id:1,name:"今天(YYYY-MM-DD)",v:"${this_day10}"},{id:2,name:"昨天(YYYY-MM-DD)",v:"${date}"},{id:3,name:"当前小时(YYYY-MM-DD HH:00:00)",v:"${this_hour}"},{id:4,name:"UNIX_TIMESTAMP",v:"${unix_timestamp}"},{id:5,name:"前一小时(YYYY-MM-DD HH:00:00)",v:"${last_hour}"}]},getCycleOptions:function(){return{H:"时",D:"日",W:"周",M:"月",Y:"年"}},getTaskGroupOption:function(){return[{ID:1,Text:"ods"},{ID:2,Text:"load"},{ID:3,Text:"dm"},{ID:4,Text:"dw"},{ID:5,Text:"export"},{ID:6,Text:"dim"},{ID:7,Text:"online"}]},getOffsetsByCycle:function(a){switch(a){case"H":return["H0","H1","H2","H3","H4","H5","H6","H7","H8","H9","H10","H11","H12","H13","H14","H15","H16","H17","H18","H19","H20","H21","H22","H23","H24"];case"D":return["D0","D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","D11","D12","D13","D14","D15","D16","D17","D18","D19","D20","D21","D22","D23","D24","D25","D26","D27","D28","D29","D30","D31"];case"W":return["W0","W1","W2","W3","W4"];case"M":return["M0","M1","M2","M3","M4","M5","M6"]}},getPriorityOption:function(){return[{ID:1,Text:"高"},{ID:2,Text:"中"},{ID:3,Text:"低"}]},getIfRecallOption:function(){return[{ID:1,Text:"是"},{ID:0,Text:"否"}]},getRecallLimitOption:function(){return[1,2,3,4,5,6,7,8,9,10]},getRecallIntervalOption:function(){return[{ID:1,Text:"1分钟"},{ID:2,Text:"2分钟"},{ID:3,Text:"3分钟"},{ID:4,Text:"4分钟"},{ID:5,Text:"5分钟"},{ID:6,Text:"6分钟"},{ID:7,Text:"7分钟"},{ID:8,Text:"8分钟"},{ID:9,Text:"9分钟"},{ID:10,Text:"10分钟"}]},getOffsetOption:function(){return["D0","D1","D2","D3","D4","D5","D6","D7","D8","D9","D10","M0","M1","M2","M3","M4","M5","M6","M7","M8","M9","M10"]},getTimeOutOption:function(){return[{ID:30,Text:"30分钟"},{ID:60,Text:"1小时"},{ID:90,Text:"1.5小时"},{ID:120,Text:"2小时"},{ID:150,Text:"2.5小时"},{ID:180,Text:"3小时"},{ID:210,Text:"3.5小时"},{ID:240,Text:"4小时"}]},statusToText:function(a){switch(a){case 1:return"success";case-1:return"fail";case 0:return"init";case 4:return"init-error";case 3:return"suspend";case 5:return"wait";case 2:return"running";case 6:return"ready";case 7:return"timeout";default:return"未知"}},cycleToText:function(a){switch(a){case"H":return"小时";case"D":return"日";case"W":return"周";case"M":return"月";case"mi":return"分"}},getTransferHivePartition:function(){return[{id:1,name:"无分区",partition:""},{id:2,name:"ds",partition:"ds string"},{id:3,name:"ds,hour",partition:"ds string,hour string"}]},getStoragePattern:function(){return[{id:1,pattern:"incr"},{id:2,pattern:"snapshot"},{id:3,pattern:"zip"},{id:4,pattern:"full"},{id:5,pattern:"chage"}]},getPartitionDesc:function(){return[{id:1,name:"h",desc:"天(ds),小时(hour)"},{id:2,name:"d",desc:"天(ds)"},{id:3,name:"w",desc:"周(week)"},{id:4,name:"m",desc:"月(month)"},{id:5,name:"y",desc:"年(year)"},{id:7,name:"n",desc:"无分区"}]},getTopic:function(){return[{id:1,name:"common",ab:"com"},{id:2,name:"user",ab:"usr"},{id:3,name:"order",ab:"odr"},{id:4,name:"traffic",ab:"tra"}]},getPartitionByCycle:function(){return{H:"/ds=${yyyy-MM-dd;P1H}/hour=${HH;P1H}",HD:"/ds=${yyyy-MM-dd;P1D}",D:"/ds=${yyyy-MM-dd;P1D}",W:"/week=${yyyy-MM-dd;F1W}",M:"/month=${yyyy-MM;P1M}",Y:"/year=${yyyy;P1Y}"}}}}]),fanliApp.factory("DimService",["$resource","serverAddress",function(a,b){return a(b+"/dim/:action",{},{queryAllDevelopers:{method:"GET",params:{action:"developers"}},queryAllTargetTables:{method:"GET",params:{action:"targetDBs"}},querySourceDB:{method:"GET",params:{action:"dbSource",type:"@type"}}})}]),fanliApp.factory("DolService",["$resource","serverAddress",function(a,b){return a(b+"/dol/:action",{},{parseDolToGetTable:{method:"GET",params:{action:"tableName",dolName:"@dolName"}}})}]),angular.module("job_manage.service",["ngResource"]).factory("JobManageService",["$resource","serverAddress",function(a,b){return a(b+"/taskManager/:action",{},{addTask:{method:"POST",params:{action:"taskConfAdd"}},queryTasks:{method:"GET",params:{action:"queryTasks",taskGroupId:"@group",owner:"@owner",taskId:"@id",isValid:"@isValid"}},updateTask:{method:"POST",params:{action:"updateTask"}},queryTaskById:{method:"GET",params:{action:"task",taskid:"@taskid"}},queryPreTaskById:{method:"GET",params:{action:"queryPre",taskid:"@taskid"}},updatePre:{method:"POST",params:{action:"updateTaskRela"}},addTransferTask:{method:"POST",params:{action:"transferTaskAdd"}},getTransferTaskById:{method:"GET",params:{action:"queryTransferById",taskid:"@taskid"}},updateTransferTask:{method:"POST",params:{action:"updateTransfer"}},addEtlLoadCfg:{method:"POST",params:{action:"insertTransferParam"}},invalidTask:{method:"POST",params:{action:"invalidTask",taskId:"@taskId"}},validateTask:{method:"POST",params:{action:"validateTask",taskId:"@taskId"}},deleteTask:{method:"POST",params:{action:"deleteTask",taskId:"@taskId"}},getInfluencedTasksByTaskId:{method:"GET",params:{action:"relaTask",taskId:"@taskId"}},preRunTask:{method:"POST",params:{action:"preRunTask",startTime:"@startTime",endTime:"@endTime",taskId:"@taskId"}},addPreTask:{}})}]),angular.module("job_monitor.service",["ngResource"]).factory("JobMonitorService",["$resource","serverAddress",function(a,b){return a(b+"/monitor/:action",{},{recallInstance:{method:"POST",params:{action:"recallInstance",instanceId:"@instanceId"}},successInstance:{method:"POST",params:{action:"successInstance",instanceId:"@instanceId"}},getDirectInfluencedInstancesByInstanceId:{method:"GET",params:{action:"getDirectInfluencedInstancesByInstanceId",instanceId:"@instanceId"}}})}]),angular.module("table.service",["ngResource"]).factory("TableService",["$resource","$routeParams","serverAddress",function(a,b,c){return a(c+"/table/:action",{},{queryCreateTableSql:{method:"POST",params:{action:"buildTableSql"}},buildHiveTable:{method:"POST",params:{action:"build"}}})}]),angular.module("fanli.filter",[]).filter("StringReplace",function(){return function(a,b,c){var d=new RegExp(b,"g");return void 0===a?"":a.replace(d,c)}}).filter("dateFormat",function(){return function(a,b,c){Date.prototype.format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};(/(y+)/.test(a)||/(Y+)/.test(a))&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a};var d=new Date;if(0==c){var e=a.split("-");return d.setFullYear(e[0],e[1]-1,e[2]),d.format(b)}return new Date(a).format(b)}});